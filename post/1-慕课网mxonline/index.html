<!DOCTYPE html><html lang="zh-Hans" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  
  
  <meta name="generator" content="Wowchemy 5.0.0-beta.1 for Hugo">
  

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="CoMath">

  
  
  
    
  
  <meta name="description" content="慕课网 MxOnline 整理笔记.">

  
  <link rel="alternate" hreflang="zh-Hans" href="https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#1565c0">
  

  
  

  
  
  
  
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" media="print" onload="this.media='all'">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.2/lazysizes.min.js" integrity="sha512-TmDwFLhg3UA4ZG0Eb4MIyT1O1Mb+Oww5kFG0uHqXsdbyZz9DcvYQhKpGgNkamAI6h2lGGZq2X8ftOJvF/XjTUg==" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.9d711cebf380679328885aff8188d64e.css">

  




  

  


  
  

  

  
  <link rel="manifest" href="/index.webmanifest">
  

  <link rel="icon" type="image/png" href="/images/icon_hue90aa69698efeb53250d93a62bbb007f_97431_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hue90aa69698efeb53250d93a62bbb007f_97431_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="CoMath">
  <meta property="og:url" content="https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/">
  <meta property="og:title" content="Django学习笔记 | CoMath">
  <meta property="og:description" content="慕课网 MxOnline 整理笔记."><meta property="og:image" content="https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/featured.jpeg">
  <meta property="twitter:image" content="https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/featured.jpeg"><meta property="og:locale" content="zh-Hans">
  
    
      <meta property="article:published_time" content="2021-01-31T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2021-01-31T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/"
  },
  "headline": "Django学习笔记",
  
  "image": [
    "https://CoMath21.github.io/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/featured.jpeg"
  ],
  
  "datePublished": "2021-01-31T00:00:00Z",
  "dateModified": "2021-01-31T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Xin态好先生"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "CoMath",
    "logo": {
      "@type": "ImageObject",
      "url": "https://CoMath21.github.io/images/logo_hud8da91bfe93f3d7d35fd2296e35ef0bf_39934_192x192_fit_lanczos_2.png"
    }
  },
  "description": "慕课网 MxOnline 整理笔记."
}
</script>

  

  


  


  





  <title>Django学习笔记 | CoMath</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  ">

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.7264cf0eba3b66951b36da7d2cecf9c5.js"></script>

  

<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>搜索</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/images/logo_hud8da91bfe93f3d7d35fd2296e35ef0bf_39934_0x70_resize_lanczos_2.png" alt="CoMath"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="切换导航">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/images/logo_hud8da91bfe93f3d7d35fd2296e35ef0bf_39934_0x70_resize_lanczos_2.png" alt="CoMath"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        

        

        
        
        
        

        
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/"><span>首页</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="/post"><span>归档</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/category"><span>分类</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/tag"><span>标签</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/talk"><span>说说</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/people"><span>关于</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>浅色</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>深色</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>自动</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Django学习笔记</h1>

  

  


<div class="article-metadata">

  
  
  
  
  <div>
    

  <span >
      <a href="/authors/admin/">Xin态好先生</a></span>, <span >
      <a href="/authors/comath/">CoMath</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    2021年1月31日
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    24 分钟阅读时长
  </span>
  

  
  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a>, <a href="/category/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></span>
  

</div>

  














</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 405px;">
  <div style="position: relative">
    <img src="/post/1-%E6%85%95%E8%AF%BE%E7%BD%91mxonline/featured_huba5062a89fdcbcdc6579232fb3c8e315_45213_720x0_resize_q75_lanczos.jpeg" alt="" class="featured-image">
    <span class="article-header-caption">CoMath</span>
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <p>　　Python下有许多款不同的 Web 框架. Django是最有代表性的一个. 许多成功的网站和APP都基于Django. 2019年通过慕课网的视频教学整理了由基于Django的网站开发. 整过过程持续了多长时间已经记不清了. 中间很多磕磕碰碰，网上找了很多材料整合成了一个笔记. 本来想着能接着做点东西，但后来还是没捡起来.</p>
<h2 id="虚拟环境的安装与配置">虚拟环境的安装与配置</h2>
<h3 id="virtualenv">virtualenv</h3>
<p>virtualenv是一款轻量级第三方虚拟环境管理工具.</p>
<h4 id="windows">Windows</h4>
<p>安装virtualenv命令：pip install virtualenv</p>
<p>pip安装技巧：python豆瓣源：https://pypi.doubanio.com/simple/</p>
<p>安装时中间加入豆瓣源即可，如：</p>
<p>pip3 install -i <a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> selenium</p>
<p>easy_install -i <a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> selenium</p>
<p>创建虚拟环境：</p>
<ul>
<li>正常创建：virtualenv 虚拟环境名称</li>
<li>其他版本：virtualenv -p python版本\python.exe 虚拟环境名称</li>
</ul>
<p>进入到虚拟环境的目录下执行activate.bat命令启动虚拟环境</p>
<p>退出虚拟环境deactivate.bat命令</p>
<p><img src="./1.jpg" alt="1563103307424"></p>
<p><img src="./2.jpg" alt="1563103375274"></p>
<h4 id="linux">Linux</h4>
<p>安装virtualenv命令：sudo apt-get install python-virtualenv</p>
<p>创建虚拟环境：virtualenv 虚拟环境名称（默认是Python2.7版本）</p>
<p>需要进入到虚拟环境的bin目录下执行source activate启动虚拟环境</p>
<p><img src="./3.jpg" alt="1563089841365"></p>
<p>退出虚拟环境命令：deactivate</p>
<p>创建Python3的虚拟环境：</p>
<p>virtualenv -p python3目录 虚拟环境名称</p>
<p>virtualenv -p /usr/bin/python3 py3test</p>
<p><img src="./4.jpg" alt="1563091155983"></p>
<h3 id="virtualenvwrapper">virtualenvwrapper</h3>
<p>virtualenv使用过于麻烦，所以便于管理，使用virtualenvwrapper（依赖virtualenv）</p>
<h4 id="windows-1">Windows</h4>
<p>安装：</p>
<p>​	pip install virtualenvwrapper-win</p>
<p>命令：</p>
<ul>
<li>workon：查看所有虚拟环境；</li>
<li>workon XXX：启动名为XXX的虚拟工作环境；</li>
<li>mkvirtualenv XXX ：创建名为XXX的虚拟环境；（目录在C:\Users\Wise_Hai\Envs）</li>
<li>mkvirtualenv &ndash;python=python版本目录\python.exe XXX：创建名为XXX的python版本的虚拟环境；</li>
<li>deactivate：关闭当前虚拟环境.</li>
</ul>
<p><img src="./5.jpg" alt="1563104365797"></p>
<p>配置工作环境（可选）</p>
<ol>
<li>计算机右键属性 》高级系统设置 》环境变量</li>
<li>新建系统变量
<ul>
<li>变量名：WORKON_HOME</li>
<li>变量值：工作环境地址</li>
</ul>
</li>
<li>保存并退出，重新开启命令行窗口</li>
<li>如果需要，可以找到之前的虚拟环境目录将其中的虚拟环境直接拷贝过来即可.</li>
</ol>
<p>备注：可在虚拟环境中安装任意包，如果出错可以在<a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="noopener">这里</a>中找到安装失败的包及相应的版本进行下载安装，在执行之前的安装命令.</p>
<p><img src="./6.jpg" alt="1563104605220"></p>
<h4 id="linux-1">Linux</h4>
<p>安装命令：pip install virtualenvwrapper</p>
<p>Linux不能像Windows一样直接调用mkvirtualenv，因为没有配置.</p>
<ol>
<li>创建目录来存放虚拟环境</li>
</ol>
<ul>
<li>mkdir $HOME/.virtualenvs</li>
</ul>
<ol start="2">
<li>需要通过sudo find / -name virtualenvwrapper.sh在根目录下查找virtualenvwrapper.sh文件的路径</li>
<li>配置文件：vim/sudo gedit ~/.bashrc
<ul>
<li>export  WORKON_HOME=$HOME/ .virtualenvs</li>
<li>export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3    #如果是pip3安装的virtualenvwrapper把这条加上</li>
<li>最后一行添加source virtualenvwrapper.sh文件的路径</li>
</ul>
</li>
<li>重新加载：source ~/.bashrc</li>
<li>mkvirtualenv XXX ：在~/ .virtualenvs创建名为XXX的虚拟环境</li>
<li>mkvirtualenv &ndash;python=/usr/bin/python3 XXX：创建名为XXX的python版本的虚拟环境；</li>
</ol>
<h2 id="环境配置及model设计">环境配置及Model设计</h2>
<p>环境配置（PyCharm，MySQL，Django1.11）</p>
<p>​	此项目主要是在Windows上创建并执行，所以所有环境需改成Windows环境，由于之前安装过Anconda，而虚拟环境需要pip安装virtualenv，所以通过以下方法使得Anconda与Python3.6共存，并且可以切换：</p>
<p>​	安装Python3.6（不添加到Path），在Python目录下将python.exe文件更名为python3.exe，并将其添加到Path下即可.测试：cmd中使用python3命令.</p>
<p><img src="./7.jpg" alt="1563102590513"></p>
<h3 id="项目初始化">项目初始化</h3>
<ol>
<li>
<p>创建虚拟环境（这里随便起的名字）</p>
<p><img src="./8.jpg" alt="1563107285042"></p>
</li>
<li>
<p>安装Django Rest Framework（基于Django）</p>
<ul>
<li>
<p>安装Django Rest Framework：pip install djangorestframework</p>
<p><img src="./9.jpg" alt="1563107492625"></p>
</li>
</ul>
<p>注意：DjangRestFramework没有安装Django，需要手动安装</p>
</li>
<li>
<p>安装Django</p>
<p>pip install -i <a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> django</p>
<p>地址：https://www.django-rest-framework.org/</p>
<p><img src="./09.jpg" alt="1563107875715"></p>
</li>
<li>
<p>安装markdown和django-filter</p>
<p>pip install markdown django-filter</p>
</li>
<li>
<p>Pycharm创建Django项目</p>
<p><img src="./10.jpg" alt="1563190798577"></p>
</li>
<li>
<p>测试运行</p>
<p><img src="./11.jpg" alt="1563108795550"></p>
<p><img src="./12.jpg" alt="1563108864784"></p>
</li>
<li>
<p>更改数据库配置</p>
<p>将setting.py中的DATABASE内容</p>
<p><img src="./13.jpg" alt="1563109120733"></p>
<pre><code class="language-python">DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',  # 连接mysql数据库
        'NAME': &quot;mxshop&quot;,  # 数据库名称
        'USER': 'root',  # 账户
        'PASSWORD': &quot;root&quot;,  # 密码
        'HOST': &quot;127.0.0.1&quot;,  # 地址
        &quot;OPTIONS&quot;:{&quot;init_command&quot;:&quot;SET default_storage_engine=INNODB;&quot;} # mysql数据库的版本5.6以后
        # 'OPTIONS': { 'init_command': 'SET storage_engine=INNODB;' }
        # 用于第三方登录
    }
}
</code></pre>
</li>
<li>
<p>创建数据库</p>
<p>MySQL数据库下创建名为mxshop的数据库（此时重新运行醒目会出现数据库连接错误，主要是因为缺少连接数据的mysqlckient或者MySQL-python包）</p>
<p><img src="./14.jpg" alt="1563109995778"></p>
</li>
<li>
<p>安装mysqlclient数据库</p>
<p>pip install -i <a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> mysqlclient</p>
<p>此处可能有坑，如果报错无法安装，https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysqlclient找到对应版本下载，通过pip install xx 安装即可</p>
<p><img src="./15.jpg" alt="1565411225582"></p>
<p>如果出现下面问题，可能的问题</p>
<p>?: (mysql.W002) MySQL Strict Mode is not set for database connection &lsquo;default&rsquo;
HINT: MySQL&rsquo;s Strict Mode fixes many data integrity problems in MySQL, such as data truncation upon insertion, by escalating warnings into errors. It is strongly recommended you activate it. See: <a href="https://docs.djangoproject.com/en/2.1/ref/databases/#mysql-sql-mode">https://docs.djangoproject.com/en/2.1/ref/databases/#mysql-sql-mode</a></p>
<pre><code># 解决
DATABASES = {    
 'default': {     
     'OPTIONS': {  
         &quot;init_command&quot;: &quot;SET sql_mode='STRICT_TRANS_TABLES'&quot;,     
            }   
    }
}
</code></pre>
</li>
<li>
<p>安装图片处理包</p>
<p>pip install -i <a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> pillow</p>
</li>
<li>
<p>整理项目结构</p>
<p>创建Package</p>
<ul>
<li>apps：保存所有app</li>
<li>extra_apps：存放第三方的包，随着源码包打包而不会安装到虚拟环境中</li>
</ul>
<p>创建Directory</p>
<ul>
<li>media：保存图片等</li>
<li>db_tools：数据库初始化等</li>
</ul>
<p>为了以后方便将apps和extra_apps映射Sources Root并且加入到setting的搜索目录下</p>
<p><img src="./16.jpg" alt="1563111411195"></p>
<pre><code class="language-python">import sys
sys.path.insert(0, BASE_DIR)
sys.path.insert(0, os.path.join(BASE_DIR, 'apps'))
sys.path.insert(0, os.path.join(BASE_DIR, 'extra_apps'))
</code></pre>
</li>
</ol>
<h3 id="app-models设计">app models设计</h3>
<p>在Tools的Run manage.py Task下运行startapp xxx创建model</p>
<p><img src="./17.jpg" alt="1565438154785"></p>
<p><img src="./18.jpg" alt="1565438175298"></p>
<p>找到对应model的逻辑，创建相应的model</p>
<p>注意：此处有坑！！</p>
<p>与视频不同的地方在于django以及MySQL的版本不同，创建外键的时候需要添加<code>on_delete=models.CASCADE</code></p>
<h5 id="users-用户相关">users-用户相关</h5>
<p>这里面主要是使用UserProfile覆盖了原Users</p>
<pre><code class="language-python"># _*_ encoding:utf-8
from datetime import datetime

from django.db import models
from django.contrib.auth.models import AbstractUser


class UserProfile(AbstractUser):
    nick_name = models.CharField(max_length=50, verbose_name=u&quot;昵称&quot;, default=&quot;&quot;)
    birthday = models.DateField(verbose_name=u&quot;生日&quot;, null=True, blank=True)
    gender = models.CharField(max_length=5, choices=((&quot;male&quot;, u&quot;男&quot;), (&quot;female&quot;, &quot;女&quot;)), default=&quot;female&quot;)
    address = models.CharField(max_length=100, default=u&quot;&quot;)
    mobile = models.CharField(max_length=11, null=True, blank=True)
    image = models.ImageField(upload_to=&quot;image/%Y/%m&quot;, default=u&quot;image/default..jpg&quot;, max_length=100)

    class Meta:
        verbose_name = u&quot;用户信息&quot;
        verbose_name_plural = verbose_name

    def __unicode__(self):
        return self.username


class EmailVerifyRecord(models.Model):
    code = models.CharField(max_length=20, verbose_name=u&quot;验证码&quot;)
    email = models.EmailField(max_length=50, verbose_name=u&quot;邮箱&quot;)
    send_type = models.CharField(max_length=10, choices=((&quot;register&quot;, u&quot;注册&quot;), (&quot;forget&quot;, u&quot;找回密码&quot;)))
    send_time = models.DateTimeField(default=datetime.now)

    class Meta:
        verbose_name = u&quot;邮箱验证码&quot;
        verbose_name_plural = verbose_name

    # def __unicode__(self):
    #     return self.username


class Banner(models.Model):
    title = models.CharField(max_length=100, verbose_name=u&quot;标题&quot;)
    image = models.ImageField(upload_to=&quot;banner/%Y/%m&quot;, verbose_name=u&quot;轮播图&quot;)
    url = models.URLField(max_length=200, verbose_name=u&quot;访问地址&quot;)
    index = models.IntegerField(default=100, verbose_name=u&quot;顺序&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;轮播图&quot;
        verbose_name_plural = verbose_name
</code></pre>
<h5 id="courses-课程相关">courses-课程相关</h5>
<pre><code class="language-python"># _*_ encoding:utf-8
from django.db import models
from datetime import datetime


class Course(models.Model):
    name = models.CharField(max_length=50, verbose_name=u&quot;课程名称&quot;)
    desc = models.CharField(max_length=50, verbose_name=u&quot;课程描述&quot;)
    detail = models.TextField(verbose_name=u&quot;课程详情&quot;)
    degree = models.CharField(max_length=2, choices=((&quot;cj&quot;, &quot;初级&quot;), (&quot;zj&quot;, &quot;中级&quot;), (&quot;gj&quot;, &quot;高级&quot;)))
    learn_times = models.IntegerField(default=0, verbose_name=u&quot;学习时长（分钟）&quot;)
    students = models.IntegerField(default=0, verbose_name=u&quot;学习人数&quot;)
    fav_nums = models.IntegerField(default=0, verbose_name=u&quot;收藏人数&quot;)
    image = models.ImageField(upload_to=&quot;courses/%Y/%m&quot;, verbose_name=u&quot;封面图&quot;, max_length=100)
    click_nums = models.IntegerField(default=0, verbose_name=u&quot;点击数&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;课程&quot;
        verbose_name_plural = verbose_name


class Lesson(models.Model):
    course = models.ForeignKey(Course, verbose_name=u&quot;课程&quot;, on_delete=models.CASCADE)
    name = models.CharField(max_length=100, verbose_name=u&quot;章节名称&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;章节&quot;
        verbose_name_plural = verbose_name


class Video(models.Model):
    lesson = models.ForeignKey(Lesson, verbose_name=u&quot;课程&quot;, on_delete=models.CASCADE)
    name = models.CharField(max_length=100, verbose_name=u&quot;视频名称&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;视频&quot;
        verbose_name_plural = verbose_name


class CourseResource(models.Model):
    course = models.ForeignKey(Course, verbose_name=u&quot;课程&quot;, on_delete=models.CASCADE)
    name = models.CharField(max_length=100, verbose_name=u&quot;名称&quot;)
    download = models.FileField(upload_to=&quot;course/resource/%Y/%m&quot;, verbose_name=u&quot;资源文件&quot;,  max_length=100)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;课程资源&quot;
        verbose_name_plural = verbose_name

</code></pre>
<h5 id="organization-机构相关">organization-机构相关</h5>
<pre><code class="language-python"># _*_ encoding:utf-8
from django.db import models
from datetime import datetime


class CityDic(models.Model):
    name = models.CharField(max_length=20, verbose_name=u&quot;城市&quot;)
    desc = models.CharField(max_length=200, verbose_name=u&quot;描述&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;城市&quot;
        verbose_name_plural = verbose_name


class CourseOrg(models.Model):
    name = models.CharField(max_length=50, verbose_name=u&quot;机构名称&quot;)
    desc = models.CharField(max_length=50, verbose_name=u&quot;机构描述&quot;)
    fav_nums = models.IntegerField(default=0, verbose_name=u&quot;收藏人数&quot;)
    click_nums = models.IntegerField(default=0, verbose_name=u&quot;点击数&quot;)
    image = models.ImageField(upload_to=&quot;courses/%Y/%m&quot;, verbose_name=u&quot;封面图&quot;, max_length=100)
    address = models.CharField(max_length=150, verbose_name=u&quot;机构地址&quot;)
    city = models.ForeignKey(CityDic, on_delete=models.CASCADE, verbose_name=u&quot;所在城市&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;课程机构&quot;
        verbose_name_plural = verbose_name


class Teacher(models.Model):
    org = models.ForeignKey(CourseOrg, on_delete=models.CASCADE, verbose_name=u&quot;所属机构&quot;)
    name = models.CharField(max_length=50, verbose_name=u&quot;教师名&quot;)
    work_years = models.IntegerField(default=0, verbose_name=u&quot;工作年限&quot;)
    work_company = models.CharField(max_length=50, verbose_name=u&quot;就职公司&quot;)
    work_position = models.CharField(max_length=50, verbose_name=u&quot;公司职位&quot;)
    points = models.CharField(max_length=50, verbose_name=u&quot;教学特点&quot;)
    fav_nums = models.IntegerField(default=0, verbose_name=u&quot;收藏人数&quot;)
    click_nums = models.IntegerField(default=0, verbose_name=u&quot;点击数&quot;)

    class Meta:
        verbose_name = u&quot;教师&quot;
        verbose_name_plural = verbose_name
</code></pre>
<h5 id="operation-操作相关">operation-操作相关</h5>
<pre><code class="language-python"># _*_ encoding:utf-8
from django.db import models
from datetime import datetime

from users.models import UserProfile
from courses.models import Course


class UserAsk(models.Model):
    name = models.CharField(max_length=20, verbose_name=u&quot;姓名&quot;)
    mobile = models.CharField(max_length=11, verbose_name=u&quot;手机&quot;)
    course_name = models.CharField(max_length=50, verbose_name=u&quot;课程名&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;用户咨询&quot;
        verbose_name_plural = verbose_name


class CourseComments(models.Model):
    &quot;课程评论&quot;
    user = models.ForeignKey(UserProfile, on_delete=models.CASCADE, verbose_name=u&quot;用户&quot;)
    course = models.ForeignKey(Course, on_delete=models.CASCADE, verbose_name=u&quot;课程&quot;)
    comments = models.CharField(max_length=200, verbose_name=u&quot;评论&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;课程评论&quot;
        verbose_name_plural = verbose_name


class UserFavorite(models.Model):
    user = models.ForeignKey(UserProfile, on_delete=models.CASCADE, verbose_name=u&quot;用户&quot;)
    fav_id = models.IntegerField(default=0, verbose_name=u&quot;数据id&quot;)
    fav_type = models.IntegerField(choices=((1, &quot;课程&quot;), (2, &quot;课程机构&quot;), (3, &quot;讲师&quot;)))
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;用户收藏&quot;
        verbose_name_plural = verbose_name


class UserMessage(models.Model):
    user = models.IntegerField(default=0, verbose_name=u&quot;接收用户&quot;)
    message = models.CharField(max_length=500, verbose_name=u&quot;消息内容&quot;)
    has_read = models.BooleanField(default=False, verbose_name=u&quot;是否已读&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;用户消息&quot;
        verbose_name_plural = verbose_name


class UserCourse(models.Model):
    user = models.ForeignKey(UserProfile, on_delete=models.CASCADE, verbose_name=u&quot;用户&quot;)
    course = models.ForeignKey(Course, on_delete=models.CASCADE, verbose_name=u&quot;课程&quot;)
    add_time = models.DateTimeField(default=datetime.now, verbose_name=u&quot;添加时间&quot;)

    class Meta:
        verbose_name = u&quot;用户课程&quot;
        verbose_name_plural = verbose_name
</code></pre>
<p>考虑到存在很多models的情况，创建名为apps的Python Package，存储所有的models，并且将所有apps映射成Sources Root（否则，各个model中调用的包将报错）</p>
<p><img src="./19.jpg" alt="1565438643911"></p>
<p>并且，在settings.py中设置</p>
<pre><code class="language-python">import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR, 'apps'))
</code></pre>
<h3 id="文件上传操作">文件上传操作</h3>
<p>设置字段的时候存在上传文件路径，所以需要配置文件上传的目录</p>
<pre><code>image = models.ImageField(upload_to=&quot;courses/%Y/%m&quot;)
</code></pre>
<p>项目根目录下创建名为miedia的Directory，然后在settings.py中添加</p>
<pre><code>MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
</code></pre>
<h3 id="文件上传访问">文件上传访问</h3>
<p>配置文件上传访问处理函数</p>
<pre><code>from django.views.static import serve
from mxonline.settings import MEDIA_ROOT

# 配置文件上传的访问处理函数
    url(r'^media/(?P&lt;path&gt;.*)$', serve, {&quot;document_root&quot;: MEDIA_ROOT}),
</code></pre>
<p>配置上下文处理器（在settings.py中找到TEMPLATES下的<code>'context_processors'</code> 添加<code>'django.template.context_processors.media',</code>),其目的是将<code>{{ MEDIA_URL }}</code>注册到url中</p>
<pre><code class="language-python">TEMPLATES = [
    {
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.media',
            ],
        },
    },
]
</code></pre>
<p>在对应位置即可访问上传的图片</p>
<pre><code class="language-python">&lt;img width=&quot;200&quot; height=&quot;120&quot; class=&quot;scrollLoading&quot; data-url=&quot;{{ MEDIA_URL }}{{ xxx.image }}&quot;/&gt;
</code></pre>
<h2 id="后台管理系统">后台管理系统</h2>
<h3 id="admin">admin</h3>
<p>创建Django之后就会自动生成再带的后台管理系统（注意：红色框框）</p>
<p>在PyCharm的新版本中创建Django文件的时候，不要勾掉最后的Enable Django admin</p>
<p><img src="./20.jpg" alt="1563190798577"></p>
<p>通过http://127.0.0.1:8000/admin进行访问，但是Django并不默认生成登录账号及密码，需要通过createsuperuser注册admin后台管理的账号和密码</p>
<p><img src="./21.jpg" alt="1565439607016"></p>
<p><img src="./22.jpg" alt="1565439586940"></p>
<p>修改成中文显示：在settings.py中设置</p>
<pre><code class="language-python">LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False

</code></pre>
<p><img src="./23.jpg" alt="1565439746890"></p>
<p>默认显示的只有Group，如果想显示其他model，需要在对应的model目录下的admin中创建对应的class即可</p>
<pre><code class="language-python">form django.contrib import admin 
form .model import UserProfile

class UserProfileAdmin(admin.ModelAdmin): 	# 添加一个管理器
	pass
	
admin.site.register(UserProfile, UserProfileAdmin)	# 关联注册
</code></pre>
<h4 id="url配置技巧">url配置技巧</h4>
<pre><code class="language-python">urlpatterns = [
    # url(R'^admin/', admin.site.urls)
    url(r'^form/$', getform, name='go_form')
]
</code></pre>
<p>解释为：以^后的名字开头，以/$结尾，转到getform的views下，在html的form表单中，可以通过配置action=&quot;{%  url  &lsquo;go_form&rsquo;  %}&ldquo;提交表单.</p>
<h3 id="xadmin">xadmin</h3>
<h4 id="命令安装">命令安装</h4>
<ol>
<li>
<p>安装</p>
<p>在对应的虚拟环境中通过pip install xadmin进行安装.（依赖的安装包也会被安装）</p>
</li>
<li>
<p>环境配置</p>
<p>在项目setting.py中，找到INSTALLED_APPS，在下面添加&rsquo;xadmin&rsquo;以及&rsquo;crispy_forms'，在urls.py中，引入xadmin包，并经命令中的admin改成xadmin.</p>
<pre><code class="language-python">import xadmin
   
urlpatterns = [
 url(r'^xadmin/', xadmin.site.urls),
]
</code></pre>
</li>
<li>
<p>生成管理表单</p>
<p>配置之后，xadmin需要自己的管理表单，所以重新创建表单makemigrations，migrate</p>
</li>
</ol>
<h4 id="源码安装推荐使用">源码安装(推荐使用)</h4>
<ol>
<li>
<p>GitHub下载</p>
<p><img src="./24.jpg" alt="1563241510864"></p>
<p><img src="./25.jpg" alt="1563241532771"></p>
<p><img src="./26.jpg" alt="1563241620524"></p>
</li>
<li>
<p>安装</p>
<p>解压下载的xadmin-master.zip文件，找到其中的xadmin文件夹并将其拷贝到项目文件的根目录下，为了能够更好的管理，也为了model能够直接访问到xadmin，创建一个package包（例如：extra_apps），并将其映射成Sources Root，将xadmin文件夹拖到改文件夹下即可.</p>
<p>注意：此时可以卸载命令行安装的xadmin包，但是不要卸载自动下载的依赖包.除此之外，还需要在setting.py下注册extra_apps.</p>
<pre><code class="language-python">sys.path.insert(0, os.path.join(BASE_DIR, 'extra_apps'))
</code></pre>
<p>依赖包：</p>
<p><img src="./27.jpg" alt="1565441213393"></p>
<p>此处有坑：（Django版本在2.0以上有坑）</p>
<ul>
<li>
<p>首先报错：“ from future.utils import iteritems ImportError: No module named future.utils”</p>
</li>
<li>
<p>原因是缺少future包</p>
</li>
<li>
<p>解决方法：</p>
<ul>
<li>pip install future</li>
</ul>
</li>
<li>
<p>然后报错：from django.urls import NoReverseMatch, reverse</p>
</li>
<li>
<p>原因是django2.0 把原来的 django.core.urlresolvers 包 更改为了 django.urls包</p>
</li>
<li>
<p>解决方法：</p>
<ul>
<li>将django.core.urlresolvers 改为 django.urls</li>
</ul>
</li>
<li>
<p>有坑！！！！</p>
</li>
<li>
<p>有坑！！！！</p>
</li>
<li>
<p>有坑！！！！</p>
</li>
<li>
<p>参照https://www.cnblogs.com/netalen/p/10987016.html更改</p>
</li>
</ul>
<p>还有坑：需要将生成xadmin管理表，即执行makemigrations xadmin以及migrate xadmin.</p>
</li>
<li>
<p>环境配置</p>
<p>将model注册到xadmin：</p>
<p>在相应的model创建adminx.py文件，并且</p>
<pre><code class="language-python">import xadmin
   
from .models import modelClassName
   
class modelClassNameAdmin(object):
    list_display = ['字段1', '字段2', ...]/('',)		# 显示xadmin列表题头(最好选择数组类型)
    search_fields = ['字段1', '字段2', ...]/('',)		#搜索功能	
    listr_filter = ['字段1', '字段2', ...]/('',)		# 过滤器功能
       
xadmin.site.register(modelClassName, modelClassNameAdmin)
</code></pre>
<p>如果存在外键，在添加过滤器功能的时候需要制定通过哪个字段，如：&lsquo;User__name&rsquo;</p>
<p>这里要注意的是，添加一条数据之后需要添加以下代码，才能显示想要的数据</p>
<pre><code class="language-python">def __unicode__(self):
 return self.name
# 或者
def __str__(self):
    return self.name
</code></pre>
</li>
<li>
<p>xadmin源码安装优势</p>
<p>可以享用xadmin的新特性，并且可以根据需求添加插件等.</p>
</li>
<li>
<p>xadmin全局修改</p>
<ul>
<li>
<p>设置主题：</p>
<p>在adminx.py下创建calss</p>
<pre><code class="language-python">from xadmin import views
     
class BaseSetting(object):
   enable_themes = True
   use_bootswatch = True
         
xadmin.site.register(views.BaseAdminView, BaseSetting)    
</code></pre>
</li>
<li>
<p>全局变量</p>
<pre><code class="language-python">from xadmin import views
     
class GlobalSetting(object):
   site_title = &quot;&quot;
   site_footer = &quot;&quot;
    menu_style = &quot;accordion&quot;	# 折叠菜单
         
xadmin.site.register(views.CommAdminView, GlobalSetting)  
</code></pre>
<p><img src="./28.jpg" alt="1565495646386"></p>
<p>备注：如果需要对显示菜单名称改成中文咋需要在对应model下找到apps.py进行添加，然后更改当前目录下的<code>__init__.py</code></p>
<p>apps.py下添加<code>verbose_name = u&quot;Name&quot;</code></p>
<p><code>__init__.py</code>下添加：<code>default_app_config = model.apps.ModelConfig </code></p>
<p>注意：如果在setting.py中配置<code>.XxxConfig</code>则不需要上述<code>__init__.py</code>操作.</p>
<p><img src="./29.jpg" alt="1565496620777"></p>
</li>
</ul>
</li>
</ol>
<h2 id="前端">前端</h2>
<h3 id="首页">首页</h3>
<p>首先准备好前端页面及样式</p>
<p>在项目下创建名为static的Directory，同于存放所有的静态文件，并将img/images/css/js等文件拷贝到static文件夹下</p>
<p><img src="./30.jpg" alt="1565497383530"></p>
<p>然后在urls.py中配置url即可访问</p>
<pre><code class="language-python">from django.views.generic import TemplateView

urlpatterns = [
    url('^$', TemplateView.as_view(template_name=&quot;index.html&quot;), name=&quot;index&quot;)
]
</code></pre>
<p>存在问题：静态文件没有加载</p>
<p>解决方法：</p>
<ul>
<li>
<p>settings.py中找到<code>STATIC_URL = '/static/'</code>，在下面添加</p>
<pre><code class="language-python">STATICFILES_DIRS = (
    os.path.join(BASE_DIR, &quot;static&quot;),
)
</code></pre>
</li>
<li>
<p>在对应的html界面中找到对应的样式文件，将相对路径跟改为/static/&hellip;或者引入<code>{% load staticfiles %}</code>然后使用<code>{% static 'css/xx.css' %}</code></p>
</li>
</ul>
<h3 id="登录页面">登录页面</h3>
<h4 id="页面">页面</h4>
<ol>
<li>
<p>复制登录页面到template下，并更改样式文件</p>
</li>
<li>
<p>配置url访问路径：</p>
<pre><code>url('^login/$', TemplateView.as_view(template_name=&quot;login.html&quot;), name=&quot;login&quot;)
</code></pre>
</li>
<li>
<p>找到index.html下的登录入口，a标签更改为<code>href=&quot;/login&quot;</code>或者<code>{% url 'login' %}</code></p>
</li>
</ol>
<h5 id="url使用include">url使用include</h5>
<p>在项目下的urls.py文件中可以通过include导入其他url配置文件（url分解），也是为了更好的管理，不至于项目下的urls.py杂乱无章. 可以在对应的app下创建urls.py文件，然后导入即可.</p>
<pre><code class="language-python"># 项目下的urls.py文件
from django.conf.urls import url, include

urlpatterns = [
    # namespace命名空间
	url(r'^org/$', include('organization.urls'), namespace=&quot;org&quot;),
]
</code></pre>
<pre><code class="language-python"># organization下的urls.py
from django.conf.urls import url, include

urlpatterns = [
    # ...
	url(r'^list/$', OrgListView.as_view(), name=&quot;org_list&quot;),
]
</code></pre>
<p>访问以<code>org*</code>开头的的url都会到organization.urls中查找，提交变为</p>
<pre><code>&lt;a href=&quot;{% url 'org:org_list' %}&quot;&gt;&lt;/a&gt;
</code></pre>
<p>访问地址由原来的<code>http://127.0.0.1:8000/org-list</code>变为<code>http://127.0.0.1:8000/org/list</code></p>
<h4 id="逻辑">逻辑</h4>
<p>在users下的views.py中添加逻辑</p>
<p>注意：在view中配置函数逻辑后，就可以替换url下的内容，如：</p>
<p>在views.py中创建login函数方法</p>
<pre><code class="language-python">def login(request):
	if request.method == &quot;POST&quot;:
		pass
	elif request.method == &quot;GET&quot;:
		return render(request, &quot;login.html&quot;, {})
</code></pre>
<p>在urls.py中就可以更改为：</p>
<pre><code class="language-python">from django.views.generic import TemplateView

from model.views import login

urlpatterns = [
	url('^$', login, name=&quot;index&quot;)
]
</code></pre>
<p>注意：这里面的<code>login</code>不带()，不是点用函数方法，只是指向了<code>login</code>函数.</p>
<ul>
<li>
<p>HTML表单提交</p>
<p>主要在于action以及method，除此之外，Django自带一种安全机制，防止跨越提交，反复向后台提交表单对服务器造成负担，Django为了防止这种攻击，会做一种CSRF验证（当用post提交数据的时候，Django会去检查是否有一个CSRF的随机字符串，如果没有就会报错），所以需要在form表单里面添加<code>{% csrf_token %}</code>（可以查看页面源码,看到form中有一个input是隐藏的）!</p>
<p><img src="./31.jpg" alt="1565500485737"></p>
</li>
<li>
<p>接收数据</p>
<p>views.py通过<code>request.POST.get(&quot;labelName&quot;,&quot;&quot;)</code>来获取表单中的数据，第一个参数为参数名字，第二个参数为默认值.</p>
</li>
</ul>
<ol>
<li>
<p>基于函数的登录操作</p>
<p>Django自带的用户认证auth，django.contrib.auth中提供了许多方法，其中：</p>
<ul>
<li>
<p>authenticate()</p>
<p>提供了用户认证，即验证用户名以及密码是否正确，一般需要username  password两个关键字参数，如果认证信息有效，会返回一个  User  对象.authenticate()会在User 对象上设置一个属性来标识后端已经认证了该用户，且该信息在后续的登录过程中是需要的。当试图登陆一个从数据库中直接取出来不经过authenticate()的User对象时会报错！</p>
<pre><code class="language-python">from django.contrib.auth import authenticate
user = authenticate(username='username',password='password')
</code></pre>
<ul>
<li>
<p>User对象</p>
<p>User 对象属性：username， password（必填项）password用哈希算法保存到数据库</p>
<p>is_staff ： 用户是否拥有网站的管理权限.</p>
<p>is_active ： 是否允许用户登录, 设置为<code>False</code>，可以不用删除用户来禁止 用户登录</p>
</li>
</ul>
</li>
<li>
<p>login(HttpRequest, user)　　
该函数接受一个HttpRequest对象，以及一个认证了的User对象</p>
<p>备注：auth.login方法将校验通过的用户封装到request中，这样在request的生命周期我们都可以使用request.user得到这个用户的对象，不管是在视图函数还是在模板语言中都可以使用request.user 然后在 <code>.字段属性</code>  来取到需要的内容。此函数使用django的session框架给某个已认证的用户附加上session id等信息.</p>
<pre><code class="language-python">from django.contrib.auth import authenticate, login
        
def user_login(request):
    if request.method == &quot;POST&quot;:
        username = request.POST.get(&quot;username&quot;, &quot;&quot;)
        password = request.POST.get(&quot;password&quot;, &quot;&quot;)
        user = authenticate(username=username, password=password)
        if user is not None:
            login(request, user)
            return render(request, &quot;index.html&quot;)
        else:
            return render(request, &quot;login.html&quot;, {&quot;msg&quot;: &quot;用户名或密码错误&quot;})
    elif request.method == &quot;GET&quot;:
        return render(request, &quot;login.html&quot;, {})
</code></pre>
<p>显示错误信息：</p>
<p>逻辑代码中返回的错误信息可以用<code>{{    }}</code>来显示在页面中</p>
<pre><code class="language-python">&lt;div class=&quot;error btns login-form-tips&quot; id=&quot;jsLoginTips&quot;&gt;{{ msg }}&lt;/div&gt;
</code></pre>
<p><img src="./32.jpg" alt="1565504344116"></p>
<ul>
<li>
<p>is_authenticated()</p>
<p>判断是否已经通过了认证，但通过认证并不意味着用户拥有任何权限，这个方法甚至也不检查该用户是否处于激活状态，只是表明用户成功的通过了认证。</p>
<p>这个方法很重要, 在后台用request.user.is_authenticated()判断用户是否已经登录，如果true则可以向前台展示request.user.name</p>
<p>备注：前端可以通过<code>{% request.user.is_authenticated() %}</code>进行判断.</p>
</li>
</ul>
</li>
<li>
<p>logout(request) 注销用户　</p>
<pre><code class="language-python">from django.contrib.auth import logout
        
def logout_view(request):
  logout(request)
  # Redirect to a success page.
</code></pre>
<p>该函数接受一个HttpRequest对象，无返回值。当调用该函数时，当前请求的session信息会全部清除。该用户即使没有登录，使用该函数也不会报错.</p>
<p>备注：注销用户后，直接访问这个路径，还可以登录，但是可以<code>print(request.user)</code>，当用户通过校验登录时，得到的是一个具体的用户对象；当注销时，再次访问，就会输出AnonymousUser（是一个类 &lt;class &lsquo;django.utils.functional.SimpleLazyObject&rsquo;&gt;），意为匿名用户，可以通过这个处理一些判断.</p>
</li>
</ul>
</li>
<li>
<p>多账户信息登录</p>
<p>需要在usersModel下的views.py中创建继承<code>django.contrib.auth.backends import ModelBackends</code>的类，然后定义函数，并将函数注册到settings.py下</p>
<pre><code class="language-python">from django.contrib.auth.backends import ModelBackends
from django.db.models import Q
   
calss CustomBackend(ModelBackends):
    # 该方法会被django自动调用
    def authenticate(self, username=None, password=None, **kwargs):
        try:
            # 根据用户名查找是否存在用户(get()函数只会返回存在一个的数据)
            user = User.oject.get(username=username)
            # 如果行多个账号形式，需要导入Q包，然后执行：
            # user = User.oject.get(Q(username=username)|Q(email=username)
            if user.check_password(password):
                return user
        except Exception as e:
            retirn None
</code></pre>
<p>settings.py中配置</p>
<pre><code class="language-python">AUTHenTICATION_BACKENDS = (
 'model.views.CustomBackend',
)
</code></pre>
<p>Q：</p>
<p>a、在 filter() 等函式中关键字参数彼此之间都是 <strong>&ldquo;AND&rdquo; 关系</strong>。如果你要执行更复杂的查询(比如，实现筛选条件的 <strong>OR 关系</strong>)，可以使用 Q 对象。
b、Q对象包括 AND 关系 和OR 关系
c、Q 对象可以用 &amp; 和 | 运算符进行连接。当某个操作连接两个 Q 对象时，<strong>就会产生一个新的等价的 Q 对象。</strong></p>
<p>如：下面这段语句就产生了一个 Q ，这是用 &ldquo;OR&rdquo; 关系连接</p>
<pre><code class="language-python">Q(question__startswith='Who') | Q(question__startswith='What')
</code></pre>
<p>d、每种查询函式(比如 filter(), exclude(), get()) 除了能接收关键字参数以外，也能以位置参数的形式接受一个或多个 Q 对象。如果你给查询函式传递了多个 Q 对象，那么它们彼此间都是**&ldquo;AND&rdquo; 关系。**例如：</p>
<pre><code class="language-python">Poll.objects.get(
Q(question__startswith='Who'), Q(pub_date=date(2005, 5, 2)) |  Q(pub_date=date(2005, 5, 6))
)
</code></pre>
<p><strong>e: filter() 等函数 可以接受 Q对象和条件参数，但Q对象必须放在 条件参数前面</strong></p>
<p>settings.py中配置，重载变量</p>
</li>
<li>
<p>基于类的登录操作</p>
<p>定义继承django.views.generic.base下View的class类，直接重写get/post方法</p>
<pre><code class="language-python">from django.views.generic.base import View
   
class LoginView（View）：
 def get(self, request):
        return render(request, &quot;login.heml&quot;, {})
    def post(self, request):
        username = request.POST['username']
        password = request.POST['password']
        user = authenticate(username=username, password=password)
        if user is not None:
          login(request, user)
           # Redirect to a success page.
            ...
        else:
           # Return an 'invalid login' error message.
           ...
</code></pre>
<p>同时urls.py中还要更改为</p>
<pre><code class="language-python">from model.views import LoginView
   
urlpatterns = [
 # 调用LoginView下的as_view()方法
 url('^login/$', LoginView.as_view(), name=&quot;index&quot;)
]
</code></pre>
</li>
<li>
<p>Django  Form 表单</p>
<p>在实际的生产环境中比如登录和验证的时候，一般都使用Jquery+ajax来判断用户的输入是否为空，假如JS被禁用的话，这个认证屏障是就消失了（虽然一般不会禁用掉但是还是存在风险）</p>
<p>所以一般做两种认证一种是前端做一遍认证，在后端做一遍认证. 通过Django的form来实现.</p>
<ul>
<li>
<p>Django的form的作用：
1). 生成html标签</p>
<p>2). 用来做用户提交的验证</p>
</li>
<li>
<p>生成</p>
<p>创建forms.py脚本文件</p>
<pre><code class="language-python">from django import forms
     
class Loginform(forms.Form):
    # 要求 变量名与form表单提交的字段名一致
   email = forms.EmailField(required=True) #required是否可以为空,如果为False说明可以为空
   username = forms.CharField() #如果required不写默认为Ture
   password = forms.CharField() 
</code></pre>
<p>views.py中</p>
<pre><code class="language-python">from .forms import LginForm
     
# 创建实例,LoginForm(参数)需要传入字典类型的参数，这里将request.POST传入即可
login_form = LoginForm(request.POST)
# 就可以通过.is_valid()来判断用户输入是否合法
if login_form.is_valid():
    pass
</code></pre>
</li>
</ul>
<p>使用<code>.is_valid()</code>函数之后可以更改返回页面的错误信息，</p>
<pre><code>return render(request, &quot;login.html&quot;, {&quot;login_form&quot;: login_form})
</code></pre>
<p>html页面中获取可以使用</p>
<p>循环获取错误信息：</p>
<pre><code>{% for key, error in login_form.errors.items %}{{ error }}{% endfor %}{{ msg }} 
</code></pre>
</li>
</ol>
<h5 id="formsmodelform">Forms.ModelForm</h5>
<p>ModelForm表单同样需要导入包<code>from django import forms</code>,它可以简化元form表单的生成，即可以直接将Model转换成表单，通过定义Meta类来指定Model，并且使用files指定哪些变量为表单内容</p>
<pre><code class="language-python">from django import forms

from operation.models import UserAsk


class UserAskForm(forms.ModelForm):
    # 这里可以再添加字段
    # temp = forms.CharField()
    class Meta:
        model = UserAsk
        fields = ['name', 'mobile', 'course_name']
        
    # 如果相对某个字段进行正则判断，可以定义'clean_字段名'的函数
    def clean_mobile(self):
        # 验证手机号码是否合法
        mobile = self.cleaned_data['mobile']
        REGEX_MOBIE = &quot;^1[358]\d{9}$|^147\d{8}$|^176\\d{8}$&quot;
        p = re.compile(REGEX_MOBIE)
        if p.match(mobile):
            return mobile
        else:
            # 抛出异常
            raise forms.ValidationError(u&quot;手机号码非法&quot;, &quot;mobile_invalid&quot;)
</code></pre>
<p>实例化过程</p>
<pre><code class="language-python">class AddUserAskView(View):
	def post(self, request):
    	userask_form = UserAskForm(request.POST)
        if userask_form.valid():
            user_ask = userask_form.save(commit=True)
</code></pre>
<p>备注：无需提取表单信息，直接save()即可</p>
<p>注意：需要指定save()参数<code>commit=TRUE</code>否则无法存入数据库</p>
<h3 id="注册页面">注册页面</h3>
<h4 id="页面-1">页面</h4>
<h5 id="django-captcha-验证码插件">DJango captcha 验证码插件</h5>
<p><img src="./33.jpg" alt="1563269302912"></p>
<p>下拉找到documentation online</p>
<p><img src="./34.jpg" alt="1563269425425"></p>
<p><img src="./35.jpg" alt="1563269448271"></p>
<ul>
<li>Installation</li>
</ul>
<ol>
<li>
<p>Install <code>django-simple-captcha</code> via <a href="http://pypi.python.org/pypi/pip" target="_blank" rel="noopener">pip</a>: <code>pip install  django-simple-captcha</code></p>
</li>
<li>
<p>Add <code>captcha</code> to the <code>INSTALLED_APPS</code> in your <code>settings.py</code></p>
</li>
<li>
<p>Run <code>python manage.py migrate</code></p>
</li>
<li>
<p>Add an entry to your <code>urls.py</code>:</p>
<pre><code class="language-python">urlpatterns += [
    url(r'^captcha/', include('captcha.urls')),
]
</code></pre>
</li>
</ol>
<ul>
<li>
<p>Adding to a Form</p>
<pre><code class="language-python">from django import forms
from captcha.fields import CaptchaField
  
class CaptchaTestForm(forms.Form):
    myfield = AnyOtherField()
    captcha = CaptchaField()
</code></pre>
<p>实例化CaptchaTestForm，传给前台在对应位置添加<code>{{ CaptchaTestForm.captcha }}</code>即可.</p>
</li>
</ul>
<h4 id="逻辑-1">逻辑</h4>
<pre><code class="language-python">from django import forms
from captcha.fields import CaptchaField

class RegisterForm(forms.Form):
    myfield = AnyOtherField()  	# 与页面一一对应
    captcha = CaptchaField()	# 可以添加参(error_messages={&quot;错误内容&quot;:&quot;将显示的错误信息&quot;})
</code></pre>
<p>在views.py中创建RegisterView(View)类， 然后再前端验证码label下面添加<code>{{ register_form.captcha  }}</code></p>
<pre><code class="language-python">from django.contrib.auth.hashers import make_password

class RegisterView(View):
    def get(self, request)
        register_form = RegisterForm()	# 实例化注册表单
        return render(request, &quot;register.html&quot;, {&quot;register_form&quot;:register_form})

	def post(self, request):
    	# 创建实例register_form(参数)
        register_form = RegisterForm(request.POST)
        # 就可以通过.is_valid()来判断用户输入是否合法
        if register_form.is_valid():
            # ...
            user.password = make_password(password)
            user.save()  
            
            # 如果发送邮件执行发送邮箱验证代码
            return 
        else:
            return 
</code></pre>
<p>创建逻辑即可，值得一提的是存储明码的时候需要存密文，所以需要加密：</p>
<pre><code class="language-python">from django.contrib.auth.hashers import make_password

user.password = make_password(password)
</code></pre>
<h3 id="发送邮箱验证">发送邮箱验证</h3>
<ul>
<li>
<p>注册邮箱账号</p>
<p>首先注册邮箱账号（以新浪/网易邮箱为例），在常规设置中找到：<strong>POP3/SMTP/IMAP</strong></p>
<p><img src="./36.jpg" alt="1565013445488"></p>
<p><img src="./37.jpg" alt="1565012864520"></p>
</li>
<li>
<p>配置Email</p>
<p>settings.py中添加</p>
</li>
</ul>
<pre><code class="language-python">  EMAIL_HOST = &quot;smtp.sina.com&quot;
  EMAIL_PORT= 25
  EMAIL_HOST_USER = &quot;xxx@xxx.com&quot;
  EMAIL_HOST_PASSWORD = &quot;xxxxxx&quot; # 这里的PASSWORD是授权码，而不是普通的邮箱密码
  EMAIL_USE_TLS = False
  EMAIL_FORM = &quot;xxx@xxx.com&quot;
</code></pre>
<ul>
<li>
<p>函数</p>
<pre><code class="language-python">from random import Random
from django.core.mail import send_mail
  
def random_str(randomlength=8):
    str = ''
    chars = 'AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789'
    length = len(chars) - 1
    random = Random()
    for i in range(randomlength):
        str += chars[random.randint(0, length)]
    return str
  
def send_register_email(email, send_type=&quot;register&quot;): 
    email_record = EmailVerifyRecord()
  code = random_str(16)
    email_record.code = code
    email_record.email = email
    email_record.type = send_type
    email_record.save()
      
    email title=&quot;&quot;
    email body=&quot;&quot;
  if send type==&quot;register&quot;：
        email_title=&quot;在线网注册激活链接”
      email_body=&quot;请点击下面的链接激活你的账号：http://127.0.0.1：8000/active/{0}&quot;.format(code)
    # 返回状态
    send_status = send_mail(email_title, email_body, EMAIL_FORM, [email])
    # send_status = send_mail(email_title, email_body, 需要导入settings.py, 列表list类型)	返回状态为0/1
  if send_status:
      pass
    else:
        pass
</code></pre>
</li>
<li>
<p>激活操作</p>
<ul>
<li>urls.py配置拿到随机码进行匹配</li>
</ul>
<pre><code class="language-python">url(r'^active/(?P&lt;Name&gt;.*)/$', ActiveUserView.as_view())
# 提取active/后面所有的东西存到Name中
</code></pre>
<pre><code class="language-python">class ActiveUserView(View):
  def get(self, request, Name)
          all_records = EmaolVerifyRecord.object.filter(code=Name)
          if all_records:
              for record in all_records:
                  email = record.mail
                  user = User.object.get(email=email)
                  user.active = True
                  user.save()
          return ...
</code></pre>
<p><img src="./38.jpg" alt="1565534156646"></p>
<p>在django中，查询经常用的两个API：get()和filter()两个方法，</p>
<ul>
<li>object.get()：得到的是一个对象，如果在数据库中查不到这个对象或者查找到对象都会报错！！！</li>
<li>object.filter() ：返回的是一个对象列表。如果在数据库中找不到这个对象，那么会返回一个空列表[]</li>
</ul>
</li>
</ul>
<h3 id="找回密码">找回密码</h3>
<h4 id="urlspy中配置链接">urls.py中配置链接</h4>
<pre><code class="language-python">url(r'^active/(?P&lt;Name&gt;.*)/$', ForgetPwdView.as_view(), name=&quot;forget_pwd
&quot;)
</code></pre>
<p>找到忘记密码的<a>标签，将<code>href='{% url 'forget_pwd' %}'</code></p>
<pre><code class="language-python">class ForgetPwdView(View):
  def get(self, request)
    forget_form = ForgetForm()	# 实例化忘记密码表单
    return render(request, &quot;forget.html&quot;,{&quot;forget_form&quot;:forget_form})

	def post(self, request)
        forget_form = ForgetForm(request.POST)
        if forget_form.is_valid():
            # ...
            email = request.POST.get(&quot;email&quot;)
            
            # 如果发送邮件执行发送邮箱验证代码
            return 
        else:
            return 
</code></pre>
<h4 id="激活操作">激活操作</h4>
<p>urls.py配置拿到随机码进行匹配</p>
<pre><code>url(r'^reset/(?P&lt;Name&gt;.*)/$', ResetView.as_view())
</code></pre>
<pre><code class="language-python">class ResetView(View):
	def get(self, request, Name)
  		all_records = EmaolVerifyRecord.object.filter(code=Name)
          if all_records:
              for record in all_records:
                  email = record.mail
                  return render(request, &quot;password.html&quot; {&quot;email&quot;:email})
            else: 
                return 
    def post(self, request):
        ...  

class ModifyPwdView(View):
    def post(self, request):
        modify_form = ModifyPwdForm(request.POST)
        if modify_form.is_valid():
            email = request.POST.get(&quot;email&quot;, &quot;&quot;)
            password1 = request.POST.get(&quot;password1&quot;, &quot;&quot;)
            password2 = request.POST.get(&quot;password2&quot;, &quot;&quot;)
            if password1 != password2:
                return render(request, &quot;password_reset.html&quot;, {&quot;email&quot;: email, &quot;msg&quot;: &quot;密码不一致&quot;})
            modify_user = UserProfile.objects.get(email=email)
            modify_user.password = make_password(password1)
            modify_user.save()
            return render(request, &quot;login.html&quot;)
        else:
            return render(request, &quot;login.html&quot;, {&quot;modify_form&quot;: modify_form})

</code></pre>
<h2 id="机构的功能实现">机构的功能实现</h2>
<h3 id="django网页模板的继承block">Django网页模板的继承block</h3>
<ol>
<li>
<p>新建母版html文件（在里面挖坑block）</p>
<pre><code class="language-python">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    {% block title %}&lt;title&gt;模板页&lt;/title&gt;{% endblock %}
&lt;/head&gt;
&lt;body&gt;
{% block custom_bread %}
     &lt;section&gt;
        &lt;div class=&quot;wp&quot;&gt;
            &lt;ul class=&quot;crumbs&quot;&gt;
                &lt;li&gt;&lt;a href=&quot;{% url 'index' %}&quot;&gt;首页&lt;/a&gt;&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/section&gt;
{% endblock %}
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
</li>
<li>
<p>新建子网页并继承母版extends（在里面填坑）</p>
<pre><code class="language-python">{% extends 'base.html' %} # 注意： 继承语句必须放在首行 
{% block title %}授课机构列表{% endblock %}
{% block custom_bread %}
     &lt;section&gt;
        &lt;div class=&quot;wp&quot;&gt;
            &lt;ul class=&quot;crumbs&quot;&gt;
                &lt;li&gt;&lt;a href=&quot;{% url 'index' %}&quot;&gt;首页&lt;/a&gt;&gt;&lt;/li&gt;
                &lt;li&gt;课程机构&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/section&gt;
{% endblock %}
</code></pre>
</li>
<li>
<p>写路由，只需写子网页的路由即可。（无需写母版页的路由）</p>
<pre><code class="language-python">from django.shortcuts import render
from django.views.generic import View
   
class OrgListView(View):
    def get(self, request):
        return render(request, &quot;org-list.html&quot;)
</code></pre>
</li>
</ol>
<h3 id="分页功能">分页功能</h3>
<p>geihub搜索：<strong>pure pagination</strong></p>
<p><img src="./39.jpg" alt="1565613210906"></p>
<h4 id="installation">Installation</h4>
<ol>
<li>Install package from PYPI:</li>
</ol>
<pre><code>pip install django-pure-pagination
</code></pre>
<p>​	or clone and install from repository:</p>
<pre><code>git clone git@github.com:jamespacileo/django-pure-pagination.git
cd django-pure-pagination
python setup.py install
</code></pre>
<ol start="2">
<li>Add pure_pagination to INSTALLED_APPS</li>
</ol>
<pre><code>INSTALLED_APPS = (
    ...
    'pure_pagination',
)
</code></pre>
<ol start="3">
<li>
<p>Finally substitute <strong>from django.core.paginator import Paginator</strong> with <strong>from pure_pagination import Paginator</strong></p>
</li>
<li>
<p>A few settings can be set within settings.py</p>
</li>
</ol>
<pre><code>PAGINATION_SETTINGS = {
    'PAGE_RANGE_DISPLAYED': 10,
    'MARGIN_PAGES_DISPLAYED': 2,

    'SHOW_FIRST_PAGE_WHEN_INVALID': True,
}
</code></pre>
<h4 id="usage-example">Usage example</h4>
<p>Following is a simple example for <strong>function based views</strong>. For generic class-based views, see bellow.</p>
<p>view file: <strong>views.py</strong></p>
<pre><code># views.py
from django.shortcuts import render_to_response

from pure_pagination import Paginator, EmptyPage, PageNotAnInteger


def index(request):

    try:
        page = request.GET.get('page', 1)
    except PageNotAnInteger:
        page = 1

    objects = ['john', 'edward', 'josh', 'frank']

    # Provide Paginator with the request object for complete querystring generation
	# 需要传递三个参数，中间参数为每页显示数据
    p = Paginator(objects, 5, request=request)

    people = p.page(page)

    return render_to_response('index.html', {
        'people': people,
    }
</code></pre>
<p>template file: <strong>index.html</strong></p>
<pre><code>{# index.html #}
{% extends 'base.html' %}

{% block content %}

{% for person in people.object_list %}
    &lt;div&gt;
        First name: {{ person }}
    &lt;/div&gt;
{% endfor %}

{# The following renders the pagination html #}
&lt;div id=&quot;pagination&quot;&gt;
    {{ people.render }} # 默认页码样式
&lt;/div&gt;

{% endblock %}
</code></pre>
<p>自定义页码样式</p>
<h4 id="usage">Usage</h4>
<p>There a few different way you can make use of the features introduced within django-pure-pagination.</p>
<p>Easiest way to render the pagination is to call the render method i.e. <strong>{{ page.render }}</strong></p>
<p>Alternatively you can access the Page object low level methods yourself</p>
<p><strong>Special note:</strong> <strong>page_obj</strong> and <strong>current_page</strong> both point to the page object within the template.</p>
<pre><code class="language-python">{% load i18n %}
&lt;div class=&quot;pagination&quot;&gt;
    {% if page_obj.has_previous %}
        &lt;a href=&quot;?{{ page_obj.previous_page_number.querystring }}&quot; class=&quot;prev&quot;&gt;&amp;lsaquo;&amp;lsaquo; {% trans &quot;previous&quot; %}&lt;/a&gt;
    {% else %}
        &lt;span class=&quot;disabled prev&quot;&gt;&amp;lsaquo;&amp;lsaquo; {% trans &quot;previous&quot; %}&lt;/span&gt;
    {% endif %}
    {% for page in page_obj.pages %}
        {% if page %}
            {% ifequal page page_obj.number %}
                &lt;span class=&quot;current page&quot;&gt;{{ page }}&lt;/span&gt;
            {% else %}
                &lt;a href=&quot;?{{ page.querystring }}&quot; class=&quot;page&quot;&gt;{{ page }}&lt;/a&gt;
            {% endifequal %}
        {% else %}
            ...
        {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
        &lt;a href=&quot;?{{ page_obj.next_page_number.querystring }}&quot; class=&quot;next&quot;&gt;{% trans &quot;next&quot; %} &amp;rsaquo;&amp;rsaquo;&lt;/a&gt;
    {% else %}
        &lt;span class=&quot;disabled next&quot;&gt;{% trans &quot;next&quot; %} &amp;rsaquo;&amp;rsaquo;&lt;/span&gt;
    {% endif %}
&lt;/div&gt;
</code></pre>
<p>mxonline分页设置</p>
<pre><code>&lt;ul class=&quot;pagelist&quot;&gt;
	{% if all_orgs.has_previous %}
     	&lt;li  class=&quot;long&quot;&gt;&lt;a href=&quot;?{{all_orgs.previous_page_number.querystring }}&quot;&gt;上一页&lt;/a&gt;&lt;/li&gt;
    {% endif %}
    {% for page in all_orgs.pages %}
        {% if page %}
            {% ifequal page all_orgs.number %}
            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;?{{ page.querystring }}&quot;&gt;{{ page }}&lt;/a&gt;&lt;/li&gt;
            {% else %}
            &lt;li&gt;&lt;a class=&quot;page&quot; href=&quot;?{{ page.querystring }}&quot;&gt;{{ page }}&lt;/a&gt;&lt;/li&gt;
            {% endifequal %}
        {% else %}
        	&lt;li class=&quot;none&quot;&gt;&lt;a href=&quot;&quot;&gt;...&lt;/a&gt;&lt;/li&gt;
        {% endif %}
    {% endfor %}
    {% if all_orgs.has_next %}
   		 &lt;li class=&quot;long&quot;&gt;&lt;a href=&quot;?{{ all_orgs.next_page_number.querystring }}&quot;&gt;下一页&lt;/a&gt;&lt;/li&gt;
    {% endif %}
    &lt;/ul&gt;
</code></pre>
<h3 id="分类显示及课程排行">分类显示及课程排行</h3>
<p>前端页面通过a标签向后跳提供参数，如：</p>
<pre><code>&lt;a href=&quot;?ct=pxjg&amp;city={{ city.id }}&quot;&gt;
</code></pre>
<p>view逻辑获取，并分页显示</p>
<pre><code>class OrgListView(View):
    def get(self, request):
        # 获取所有机构
        all_orgs = CourseOrg.objects.all()
        # 热门机构
        # 注意这里，排序参数前如果有‘-’则代表着降序，没有则默认升序
        hot_orgs = all_orgs.order_by(&quot;-click_nums&quot;)[:5]
        all_citys = CityDic.objects.all()
        # 取出筛选城市
        city_id = request.GET.get('city', &quot;&quot;)
        if city_id:
            all_orgs = all_orgs.filter(city_id=int(city_id))

        # 类别筛选
        category = request.GET.get('ct', &quot;&quot;)
        if category:
            all_orgs = all_orgs.filter(category=category)

        org_nums = all_orgs.count()
        try:
            page = request.GET.get('page', 1)
        except PageNotAnInteger:
            page = 1
        p = Paginator(all_orgs, 5, request=request)
        orgs = p.page(page)
        return render(request, &quot;org-list.html&quot;, {
            &quot;all_orgs&quot;: orgs,
            &quot;org_nums&quot;: org_nums,
            &quot;all_citys&quot;: all_citys,
            &quot;city_id&quot;: city_id,
            &quot;category&quot;: category,
            &quot;hot_orgs&quot;: hot_orgs
        })
</code></pre>
<p>前端以通过<code>&lt;span class=&quot;{% ifequal category &quot;pxjg&quot; %} active2{% endifequal %}&quot;&gt;培训机构&lt;/span&gt;</code>添加样式</p>
<pre><code>&lt;a href=&quot;?city={{ city.id }}&quot;&gt;&lt;span class=&quot;{% ifequal category &quot;&quot; %}active2{% endifequal %}&quot;&gt;全部&lt;/span&gt;&lt;/a&gt;
&lt;a href=&quot;?ct=pxjg&amp;city={{ city.id }}&quot;&gt;&lt;span class=&quot;{% ifequal category &quot;pxjg&quot; %} active2{% endifequal %}&quot;&gt;培训机构&lt;/span&gt;&lt;/a&gt;
</code></pre>
<pre><code># 课程排行前端

&lt;div class=&quot;right companyrank layout&quot;&gt;
&lt;div class=&quot;head&quot;&gt;授课机构排名&lt;/div&gt;
{% for hot_org in hot_orgs %}
    &lt;dl class=&quot;des&quot;&gt;
    	&lt;dt class=&quot;num fl&quot;&gt;{{ forloop.counter }}&lt;/dt&gt;
        &lt;dd&gt;
            &lt;a href=&quot;/company/2/&quot;&gt;&lt;h1&gt;{{ hot_org.name }}&lt;/h1&gt;&lt;/a&gt;
            &lt;p&gt;{{ hot_org.address }}&lt;/p&gt;
        &lt;/dd&gt;
    &lt;/dl&gt;
{% endfor %}
&lt;/div&gt;
</code></pre>
<h3 id="页面内异步提交表单">页面内异步提交表单</h3>
<p>异步操作需要ajax操作，对指定的表单声明自定义script</p>
<p>如对网页中的某一表单进行异步操作</p>
<p><img src="./40.jpg" alt="1565672331542"></p>
<p>配置url</p>
<pre><code>url('^add_ask/$', AddUserAskView.as_view(), name=&quot;add_ask&quot;),
</code></pre>
<p>表单提交逻辑</p>
<pre><code class="language-python">class AddUserAskView(View):
    def post(self, request):
        userask_form = UserAskForm(request.POST)
        if userask_form.is_valid():
            user_ask = userask_form.save(commit=True)
            return HttpResponse('{&quot;status&quot;:&quot;success&quot;}')
        else:
            return HttpResponse(json.dumps('{&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;: &quot;添加错误&quot;}', ensure_ascii=False), content_type=&quot;application/json,charset=utf-8&quot;)
            # return JsonResponse('{&quot;status&quot;:&quot;success&quot;}', safe=False)
        # else:
            # return JsonResponse('{&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;: &quot;添加错误&quot;}', safe=False)
</code></pre>
<p>备注：django一般用JsonResponse来返回json数据格式，这种方式返回简单，但是中文会乱码</p>
<pre><code class="language-python"># 格式
return JsonResponse(result, safe=False)
</code></pre>
<p>如若显示中文，需要改用HttpResponse来返回</p>
<pre><code class="language-python"># 格式
return HttpResponse(json.dumps(result,ensure_ascii=False),content_type=&quot;application/json,charset=utf-8&quot;)
</code></pre>
<p>注意： 此处有坑,result要严格按照JSON格式书写.即</p>
<pre><code>result = {&quot;status&quot;:&quot;success&quot;}
result = {&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;: &quot;添加错误&quot;}
</code></pre>
<p>写下面的javascript代码，对表单提交进行监听</p>
<pre><code class="language-python">{% block custom_js %}
&lt;script&gt;
    $(function () {
        $('#jsStayBtn').on('click', function () {
            $.ajax({
                cache: false,
                type: &quot;POST&quot;,
                url: &quot;{% url 'org:add_ask' %}&quot;,
                data: $('#jsStayForm').serialize(),
                async: true,
                success: function (data) {
                    console.log(data)
                    # 装换成JSON格式，否则data.status为undefined
                    data = JSON.parse(data)
                    console.log(data.status)
                    if (data.status == 'success') {
                        $('#jsStayForm')[0].reset();
                        alert(&quot;提交成功&quot;)
                    } else if (data.status == 'fail') {
                        $('#jsCompanyTips').html(data.msg)
                    }
                },
            });
        });
    })
&lt;/script&gt;
{% endblock %}
</code></pre>
<h3 id="机构首页课程介绍讲师">机构首页/课程/介绍/讲师</h3>
<p>点击机构图片查看机构详情等操作</p>
<p>与前面操作类似，唯一需要提到的是url配置，因为点击机构图片logo的时候需要传递参数，以便知道是哪个机构，所以</p>
<pre><code># url配置
url(r'^home/(?P&lt;org_id&gt;.*)/$', OrgHomeView.as_view(), name=&quot;org_home&quot;),
</code></pre>
<pre><code class="language-python"># view逻辑
class OrgHomeView(View):
    &quot;&quot;&quot;
    机构首页
    &quot;&quot;&quot;
    def get(self, request, org_id):
        current_page = &quot;home&quot;
        course_org = CourseOrg.objects.get(id=int(org_id))
        has_fav = False
        if request.user.is_authenticated:
            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):
                has_fav = True
        # 这里可以通过外键_set来反向获取外键数据
        all_courses = course_org.course_set.all()[:3]
        all_teachers = course_org.teacher_set.all()[:2]

        return render(request, 'org-detail-homepage.html', {
            &quot;all_courses&quot;: all_courses,
            &quot;all_teachers&quot;: all_teachers,
            &quot;course_org&quot;: course_org,
            &quot;current_page&quot;: current_page,
            &quot;has_fav&quot;: has_fav
        })


class OrgCourseView(View):
    &quot;&quot;&quot;
    机构课程
    &quot;&quot;&quot;

    def get(self, request, org_id):
        current_page = &quot;course&quot;
        course_org = CourseOrg.objects.get(id=int(org_id))
        has_fav = False
        if request.user.is_authenticated:
            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):
                has_fav = True
        all_courses = course_org.course_set.all()

        return render(request, 'org-detail-course.html', {
            &quot;all_courses&quot;: all_courses,
            &quot;course_org&quot;: course_org,
            &quot;current_page&quot;: current_page,
            &quot;has_fav&quot;: has_fav
        })


class OrgDescView(View):
    &quot;&quot;&quot;
    机构介绍
    &quot;&quot;&quot;

    def get(self, request, org_id):
        current_page = &quot;desc&quot;
        course_org = CourseOrg.objects.get(id=int(org_id))
        has_fav = False
        if request.user.is_authenticated:
            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):
                has_fav = True

        return render(request, 'org-detail-desc.html', {
            &quot;course_org&quot;: course_org,
            &quot;current_page&quot;: current_page,
            &quot;has_fav&quot;: has_fav
        })


class OrgTeacherView(View):
    &quot;&quot;&quot;
    机构讲师
    &quot;&quot;&quot;

    def get(self, request, org_id):
        current_page = &quot;teacher&quot;
        course_org = CourseOrg.objects.get(id=int(org_id))
        has_fav = False
        if request.user.is_authenticated:
            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):
                has_fav = True
        all_teachers = course_org.teacher_set.all()

        return render(request, 'org-detail-teachers.html', {
            &quot;all_teachers&quot;: all_teachers,
            &quot;course_org&quot;: course_org,
            &quot;current_page&quot;: current_page,
            &quot;has_fav&quot;: has_fav
        })
</code></pre>
<pre><code class="language-python"># 访问时需要在url 'org:org_home'后空一格，然后带上id
&lt;a href=&quot;{% url 'org:org_home' org.id %}&quot;&gt;
</code></pre>
<p>其他操作均相同，略</p>
<h3 id="用户收藏">用户收藏</h3>
<p>用户收藏操作同样是异步操作，需要ajax，因为页面采用继承式，所以只需要在org_base.html中更改即可，首先在organization的url中配置</p>
<pre><code>url(r'^add_fav/$', AddFavoriteView.as_view(), name=&quot;add_fav&quot;),
</code></pre>
<p>由于页面中的继承，在点击左侧的时候页面会刷新，导致收藏按钮更改，所以需要对每个操作（机构首页/课程/介绍/讲师）等均进行判断是否收藏，前端需要注意的是，由于界面中不存在form表单提交，所以无法使用<code>{% csrf-token %}</code>，需要在ajax向后提交的时候补充发送，即：</p>
<pre><code class="language-python">//收藏分享
function add_fav(current_elem, fav_id, fav_type) {
    $.ajax({
        cache: false,
        type: &quot;POST&quot;,
        url: &quot;{% url 'org:add_fav' %}&quot;,
        data: {'fav_id': fav_id, 'fav_type': fav_type},
        async: true,
        # ！！！！！！！！！！！！！！！！！！！！！！！
        beforeSend: function (xhr, settings) {
            xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;{{ csrf_token }}&quot;);
        },
        # ！！！！！！！！！！！！！！！！！！！！！！！
        success: function (data) {
            data = JSON.parse(data)
            console.log(data)
            console.log(data.status)
            console.log(data.msg)
            if (data.status == 'fail') {
                if (data.msg == '用户未登录') {
                    window.location.href = &quot;{% url 'login' %}&quot;;
                } else {
                    alert(data.msg)
                }

            } else if (data.status == 'success') {
                current_elem.text(data.msg)
            }
        },
    });
}

$('.collectionbtn').on('click', function () {
    add_fav($(this), {{ course_org.id }}, 2);
});
</code></pre>
<p>后台逻辑</p>
<pre><code class="language-python">class AddFavoriteView(View):
    &quot;&quot;&quot;
    用户收藏
    &quot;&quot;&quot;
    def post(self, request):
    	# 拿到前端数据
        fav_id = request.POST.get('fav_id', 0)
        fav_type = request.POST.get('fav_type', 0)

        # 判断用户是否登录(即使在未登录的情况下，request对象也会产生不同于自定义User的user对象，判断是否登录)
        if not request.user.is_authenticated:
            return HttpResponse(json.dumps('{&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;: &quot;用户未登录&quot;}', ensure_ascii=False), content_type=&quot;application/json, charset=utf-8&quot;)
        exit_records = UserFavorite.objects.filter(user=request.user, fav_id=int(fav_id), fav_type=int(fav_type))
        if exit_records:
            # 如果存在则证明已收藏，现取消收藏
            exit_records.delete()
            # 返回JSON数据
            return HttpResponse(json.dumps('{&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;: &quot;收藏&quot;}', ensure_ascii=False), content_type=&quot;application/json, charset=utf-8&quot;)
        else:
            user_fav = UserFavorite()
            if int(fav_id) &gt; 0 and int(fav_type) &gt; 0:
                user_fav.user = request.user
                user_fav.fav_id = int(fav_id)
                user_fav.fav_type = int(fav_type)
                user_fav.save()
                return HttpResponse(json.dumps('{&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;: &quot;已收藏&quot;}', ensure_ascii=False), content_type=&quot;application/json, charset=utf-8&quot;)
            else:
                return HttpResponse(json.dumps('{&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;: &quot;收藏出错&quot;}', ensure_ascii=False), content_type=&quot;application/json, charset=utf-8&quot;)
</code></pre>
<h2 id="公开课">公开课</h2>
<p>首先在courses下创建urls.py文件，然后通过导入到项目下的urls.py文件下，配置操作：</p>
<pre><code class="language-python"># urls.py
# 配置课程相关url
url(r'^course/', include('courses.urls', namespace=&quot;course&quot;)),

# courses下urls.py
url(r'^list/$', CourseListView.as_view(), name=&quot;course_list&quot;),
</code></pre>
<p>View</p>
<pre><code class="language-python">class CourseListView(View):
    def get(self, request):
        all_courses = Course.objects.all().order_by(&quot;-add_time&quot;)

        hot_courses = Course.objects.all().order_by(&quot;-click_nums&quot;)[:3]
        sort = request.GET.get(&quot;sort&quot;, &quot;&quot;)
        if sort:
            if sort == &quot;students&quot;:
                all_courses = all_courses.order_by(&quot;-students&quot;)
            elif sort == &quot;hot&quot;:
                all_courses = all_courses.order_by(&quot;-click_nums&quot;)
        org_nums = all_courses.count()

        # 对课程分页
        try:
            page = request.GET.get('page', 1)
        except PageNotAnInteger:
            page = 1

        p = Paginator(all_courses, 6, request=request)

        corses = p.page(page)

        return render(request, 'course-list.html', {
            &quot;all_courses&quot;: corses,
            &quot;hot_courses&quot;: hot_courses,
            &quot;sort&quot;: sort
        })

</code></pre>
<h3 id="课程列表">课程列表</h3>
<p>同课程机构一样，首先修改页面，只需要在对应位置进行修改（{% block %}）即可完成页面配置，然后进行url配置，在course下创建urls.py文件，最后编写后台View逻辑</p>
<pre><code class="language-python"># url 配置
url(r'^list/$', CourseListView.as_view(), name=&quot;course_list&quot;),
</code></pre>
<pre><code class="language-python">class CourseListView(View):
    def get(self, request):
        all_courses = Course.objects.all().order_by(&quot;-add_time&quot;)

        hot_courses = Course.objects.all().order_by(&quot;-click_nums&quot;)[:3]
        sort = request.GET.get(&quot;sort&quot;, &quot;&quot;)
        if sort:
            if sort == &quot;students&quot;:
                all_courses = all_courses.order_by(&quot;-students&quot;)
            elif sort == &quot;hot&quot;:
                all_courses = all_courses.order_by(&quot;-click_nums&quot;)
        org_nums = all_courses.count()

        # 对课程分页
        try:
            page = request.GET.get('page', 1)
        except PageNotAnInteger:
            page = 1

        p = Paginator(all_courses, 6, request=request)

        corses = p.page(page)

        return render(request, 'course-list.html', {
            &quot;all_courses&quot;: corses,
            &quot;hot_courses&quot;: hot_courses,
            &quot;sort&quot;: sort
        })
</code></pre>
<h3 id="课程详情">课程详情</h3>
<pre><code># 课程详情页
url(r'^detail/(?P&lt;course_id&gt;.*)/$', CourseDetailView.as_view(), name=&quot;course_detail&quot;),
</code></pre>
<pre><code>class CourseDetailView(View):
    def get(self, request, course_id):
        course = Course.objects.get(id=int(course_id))
        # 增加课程点击数
        course.click_nums += 1
        course.save()

        # 判断是否收藏
        has_fav_course = False
        has_fav_org = False
        if request.user.is_authenticated:
            if UserFavorite.objects.filter(user=request.user, fav_id=course.id, fav_type=1):
                has_fav_course = True
            if UserFavorite.objects.filter(user=request.user, fav_id=course.course_org.id, fav_type=2):
                has_fav_org = True

        tag = course.tag
        if tag:
            relate_courses = Course.objects.filter(tag=tag)[:1]
        else:
            relate_courses = []
        return render(request, 'course-detail.html', {
            &quot;course&quot;: course,
            &quot;relate_courses&quot;: relate_courses,
            &quot;has_fav_course&quot;: has_fav_course,
            &quot;has_fav_org&quot;: has_fav_org,
        })
</code></pre>
<h4 id="课程章节信息配置">课程章节信息配置</h4>
<p>获取课程的章节：打开courses/models.py文件，在Course函数里面，新定义函数def get_course_lesson用于获取课程的章节：</p>
<pre><code class="language-js">def get_course_lesson(self):
# 获取课程所有章节
	return self.lesson_set.all()
</code></pre>
<p>在lesson函数里面，新定义函数def get_lesson_video用于获取章节的视频信息：</p>
<pre><code class="language-js">def get_lesson_video(self):
	# 获取章节视频信息
	return self.video_set.all()
</code></pre>
<p>现在打开<strong>course-video.html</strong>页面，配置数据的动态显示：</p>
<pre><code class="language-js">{% for lesson in course.get_course_lesson %}
&lt;div class=&quot;chapter chapter-active&quot; &gt;
&lt;h3&gt;&lt;strong&gt;&lt;i class=&quot;state-expand&quot;&gt;&lt;/i&gt;{{ lesson.name }}&lt;/strong&gt;&lt;/h3&gt;
&lt;ul class=&quot;video&quot;&gt;
{% for video in lesson.get_lesson_video %}
	&lt;li&gt;
    &lt;a target=&quot;_blank&quot; href='/video/3662' class=&quot;J-media-item studyvideo&quot;&gt;{{ video.name }}({{ video.learn_times }})
    &lt;i class=&quot;study-state&quot;&gt;&lt;/i&gt;
	&lt;/a&gt;
	&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;
&lt;/div&gt;
{% endfor %}
</code></pre>
<h3 id="课程评论">课程评论</h3>
<p>打开courses/urls.py文件，配置课程评论页面的url</p>
<pre><code class="language-js">from .views import CourseCommentView

 # 课程评论页面url
    re_path('comment/(?P&lt;course_id&gt;.*)/', CourseCommentView.as_view(), name=&quot;course_comment&quot;),
</code></pre>
<p>然后打开courses/views.py文件，新定义课程评论页面函数：</p>
<pre><code class="language-js">from operation.models import CourseComments

# 课程评论页面
class CourseCommentView(View):
    def get(self, request, course_id):
        course = Course.objects.get(id=int(course_id))
        all_resources = CourseResource.objects.filter(course=course)
        all_comments = CourseComments.objects.all()
        return render(request, &quot;course-comment.html&quot;, {
            &quot;course&quot;: course,
            &quot;all_resources&quot;: all_resources,
            &quot;all_comments&quot;: all_comments,
        })
</code></pre>
<p>接着打开<strong>course-comment.html</strong>页面,修改跳转代码：</p>
<pre><code class="language-js">&lt;li&gt;&lt;a class=&quot;ui-tabs-active active&quot; id=&quot;learnOn&quot;  href=&quot;{% url 'courses:course_info' course.id %}&quot;&gt;&lt;span&gt;章节&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a id=&quot;commentOn&quot; class=&quot;&quot; href=&quot;{% url 'course:course_comment' course.id %}&quot;&gt;&lt;span&gt;评论&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
</code></pre>
<p>然后打开<strong>course-comment.html</strong>页面，修改课程信息，资料下载，讲师提示等, 和前面在video页面配置的一样</p>
<h3 id="课程资源">课程资源</h3>
<p>第一步，前往xadmin后台为某一门课添加课程资源，第二步打开courses/views.py文件，修改视图函数：</p>
<pre><code class="language-js">from .models import  CourseResource

all_resources = CourseResource.objects.filter(course=course)
return render(request, &quot;course-video.html&quot;, {
            &quot;all_resources&quot;: all_resources,
        })
</code></pre>
<p>打开<strong>course-video.html</strong>页面，配置资源下载的动态显示：</p>
<pre><code class="language-js">{% for resources in all_resources %}
                               &lt;li&gt;
                                &lt;span &gt;&lt;i class=&quot;aui-iconfont aui-icon-file&quot;&gt;&lt;/i&gt;&amp;nbsp;&amp;nbsp;{{ resources.name }}&lt;/span&gt;
                                &lt;a href=&quot;{{ MEDIA_URL }}{{ resources.download }}&quot; class=&quot;downcode&quot; target=&quot;_blank&quot; download=&quot;&quot; data-id=&quot;274&quot; title=&quot;&quot;&gt;下载&lt;/a&gt;
                            &lt;/li&gt;
                           {% endfor %}
</code></pre>
<p>然后刷新页面，发现显示没有问题。</p>
<p>接下在<strong>course-video.html</strong>页面完成课程信息的修改：</p>
<pre><code class="language-js">&lt;div class=&quot;static-item &quot;&gt;
	&lt;span class=&quot;meta-value&quot;&gt;&lt;strong&gt;{{ course.get_degree_display }}&lt;/strong&gt;&lt;/span&gt;
	&lt;span class=&quot;meta&quot;&gt;难度&lt;/span&gt;
	&lt;em&gt;&lt;/em&gt;
&lt;/div&gt;
&lt;div class=&quot;static-item static-time&quot;&gt;
	&lt;span class=&quot;meta-value&quot;&gt;&lt;strong&gt;{{ course.learn_times }}分钟&lt;/strong&gt;	&lt;/span&gt;
	&lt;span class=&quot;meta&quot;&gt;时长&lt;/span&gt;
	&lt;em&gt;&lt;/em&gt;
&lt;/div&gt;
&lt;div class=&quot;static-item&quot;&gt;
	&lt;span class=&quot;meta-value&quot;&gt;&lt;strong&gt;{{ course.students }}人&lt;/strong&gt;&lt;/span&gt;
	&lt;span class=&quot;meta&quot;&gt;学习人数&lt;/span&gt;
	&lt;em&gt;&lt;/em&gt;
&lt;/div&gt;
</code></pre>
<p>在配置讲师提示的时候，发现讲师和课程之间没有建立外键连接，所以在courses/models.py文件的Course函数，新增讲师字段 :</p>
<pre><code class="language-js">from organization.models import Teacher

teacher = models.ForeignKey(Teacher, on_delete=models.CASCADE, verbose_name=&quot;讲师&quot;, null=True, blank=True)
</code></pre>
<p><strong>记得数据库的变动需要两部曲：makemigrations和migrate</strong>。</p>
<p>然后前往xadmin后台为这门课添加一个讲师。然后修改<strong>course-video.html</strong>页面</p>
<h4 id="课程相关推荐">课程相关推荐</h4>
<p>打开courses/views.py文件，找到CourseInfoView这个函数，修改为如下：</p>
<pre><code class="language-js"># 课程章节信息
class CourseInfoView(View):
    def get(self, request, course_id):
        course = Course.objects.get(id=int(course_id))
        all_resources = CourseResource.objects.filter(course=course)

        # 取出所有选过这门课的学生
        user_courses = UserCourse.objects.filter(course=course)
        # 取出所有选过这门课的学生的id,采用递归表达式形式
        user_ids = [user_course.user.id for user_course in user_courses]
        # 取出刚才那些学生选过的所有的课程
        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)
        # 取出刚才那些学生选过的所有的课程的id,同样采用递归表达式形式
        course_ids = [all_user_course.course_id for all_user_course in all_user_courses]
        # 取出学过该课程用户学过的其他课程
        relate_courses = Course.objects.filter(id__in=course_ids).order_by(&quot;-click_nums&quot;)[:5]
        return render(request, &quot;course-video.html&quot;, {
            &quot;course&quot;: course,
            &quot;all_resources&quot;: all_resources,
            &quot;relate_courses&quot;: relate_courses,
        })
</code></pre>
<p><strong>注意：双下划线代表代表传进来的是一个可以遍历的list。</strong></p>
<p>接着就是在前端页面配置动态加载信息了（记得course-video.html和course_comment.html这两个页面都需要配置，一模一样）：</p>
<pre><code class="language-js">&lt;ul class=&quot;other-list&quot;&gt;
{% for relate_course in relate_courses %}
	&lt;li class=&quot;curr&quot;&gt;
	&lt;a href=&quot;{% url 'course:course_detail' relate_course.id %}&quot;target=&quot;_blank&quot;&gt;
	&lt;img src=&quot;{{ MEDIA_URL }}{{ relate_course.image }}&quot;alt=&quot;{{ relate_course.name }}&quot;&gt;
	&lt;span class=&quot;name autowrap&quot;&gt;{{ relate_course.name }}&lt;/span&gt;
	&lt;/a&gt;
	&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;
</code></pre>
<p>存在问题：那就是用户如果没有登录，那是不能让他进入课程章节这个页面的，因此需要判断一下。这里因为使用的是方法型编程所以可以使用装饰器loginrequired来进行判断。</p>
<p>在utils文件夹下面，新建一个名为mixin_utils.py文件，在里面添加如下代码：</p>
<pre><code class="language-js">from django.contrib.auth.decorators import login_required
from django.utils.decorators import method_decorator


class LoginRequiredMixin(object):

    @method_decorator(login_required(login_url='/login/'))
    def dispatch(self, request, *args, **kwargs):
        return super(LoginRequiredMixin, self).dispatch(request, *args, **kwargs)
</code></pre>
<p>接着打开courses/views.py文件，在里面修改CourseInfoView和CourseCommentView，修改后如下：</p>
<pre><code class="language-js">from utils.mixin_utils import LoginRequiredMixin

# 课程章节信息
class CourseInfoView(LoginRequiredMixin, View):
     login_url = '/login/'
    redirect_field_name = 'redirect_to'
    def get(self, request, course_id):
        course = Course.objects.get(id=int(course_id))
        all_resources = CourseResource.objects.filter(course=course)

        # 查询用户是否已经开始学习了该课程，如果没有则开始学习
        user_courses = UserCourse.objects.filter(user=request.user, course=course)
        if not user_courses:
            user_course = UserCourse(user=request.user, course=course)
            course.students += 1
            course.save()
            user_course.save()

        # 取出所有选过这门课的学生
        user_courses = UserCourse.objects.filter(course=course)
        # 取出所有选过这门课的学生的id,采用递归表达式形式
        user_ids = [user_course.user.id for user_course in user_courses]
        # 取出刚才那些学生选过的所有的课程
        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)
        # 取出刚才那些学生选过的所有的课程的id,同样采用递归表达式形式
        course_ids = [all_user_course.course_id for all_user_course in all_user_courses]
        # 取出学过该课程用户学过的其他课程
        relate_courses = Course.objects.filter(id__in=course_ids).order_by(&quot;-click_nums&quot;)[:5]
        return render(request, &quot;course-video.html&quot;, {
            &quot;course&quot;: course,
            &quot;all_resources&quot;: all_resources,
            &quot;relate_courses&quot;: relate_courses,
        })


# 课程评论页面
class CourseCommentView(LoginRequiredMixin, View):
    login_url = '/login/'
    redirect_field_name = 'redirect_to' 
    def get(self, request, course_id):
        course = Course.objects.get(id=int(course_id))
        all_resources = CourseResource.objects.filter(course=course)
        all_comments = CourseComments.objects.all()
        return render(request, &quot;course-comment.html&quot;, {
            &quot;course&quot;: course,
            &quot;all_resources&quot;: all_resources,
            &quot;all_comments&quot;: all_comments,
        })
</code></pre>
<p>刷新一下页面，点几个课程试试看，发现都在该同学还学过哪些课里推荐了。</p>
<h3 id="课程视频">课程视频</h3>
<h4 id="课程播放页面配置">课程播放页面配置</h4>
<p>打开courses/urls.py文件，新增代码：</p>
<pre><code class="language-js">from .views import  VideoPlayView

# 视频播放页面url
re_path('video/(?P&lt;video_id&gt;.*)/', VideoPlayView.as_view(), name=&quot;video_play&quot;),
或者 re_path('video/(?P&lt;video_id&gt;\d+)/', VideoPlayView.as_view(), name=&quot;video_play&quot;),都是可以的
</code></pre>
<p>接着打开courses/views.py文件，新增代码：</p>
<pre><code class="language-js">from .models import  Video

# 视频播放页面
class VideoPlayView(LoginRequiredMixin, View):
    login_url = '/login/'
    redirect_field_name = 'redirect_to'
    
    def get(self, request, video_id):
        video = Video.objects.get(id=int(video_id))
        course = video.lesson.course
        all_resources = CourseResource.objects.filter(course=course)
        # 查询用户是否已经开始学习了该课程，如果没有则开始学习
        user_courses = UserCourse.objects.filter(user=request.user, course=course)
        if not user_courses:
            user_course = UserCourse(user=request.user, course=course)
            course.students += 1
            course.save()
            user_course.save()

        # 取出所有选过这门课的学生
        user_courses = UserCourse.objects.filter(course=course)
        # 取出所有选过这门课的学生的id,采用递归表达式形式
        user_ids = [user_course.user.id for user_course in user_courses]
        # 取出刚才那些学生选过的所有的课程
        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)
        # 取出刚才那些学生选过的所有的课程的id,同样采用递归表达式形式
        course_ids = [all_user_course.course_id for all_user_course in all_user_courses]
        # 取出学过该课程用户学过的其他课程
        relate_courses = Course.objects.filter(id__in=course_ids).order_by(&quot;-click_nums&quot;)[:5]

        return render(request, &quot;course-play.html&quot;, {
            &quot;course&quot;: course,
            &quot;all_resources&quot;: all_resources,
            &quot;relate_courses&quot;: relate_courses,
            &quot;video&quot;: video,
        })
</code></pre>
<p>上面的代码和之前在课程章节信息里面定义的几乎一模一样，只是course的来源不一样。</p>
<p>接着打开<strong>course-video.html</strong>文件，配置跳转链接：</p>
<pre><code class="language-js">{% for video in lesson.get_lesson_video %}
    &lt;li&gt;
        &lt;a target=&quot;_blank&quot; href='{% url 'course:video_play' video.id %}'
 class=&quot;J-media-item studyvideo&quot;&gt;{{ video.name }}({{ video.learn_times }})
     &lt;i class=&quot;study-state&quot;&gt;&lt;/i&gt;
&lt;/a&gt;
&lt;/li&gt;
{% endfor %}
</code></pre>
<p>然后打开<strong>course-video.html</strong>文件，配置视频链接，记住由于我们这边是<strong>type=&lsquo;video/mp4&rsquo;<strong>所以后台所添加的视频必须是</strong>.mp4</strong>结尾，否则会出错。</p>
<p>备注：<strong>{{ forloop.counter|add:2 }}是为了从第三个开始计数的，这是Django自带的功能</strong></p>
<p><strong>{% if forloop.counter|divisibleby:5 %}five{% endif %}表示如果能被5整除则显示five，这也是Django自带的功能</strong></p>
<h2 id="404和500页面的配置">404和500页面的配置</h2>
<p>从前端资料里面拷贝我们的404和500页面到templates文件夹并修改文件里面的静态文件地址。打开eduline/urls.py文件，新增代码如下：</p>
<pre><code class="language-js"># 全局404页面配置
handler404 = 'users.views.page_not_found'
</code></pre>
<p>然后打开users/views.py文件，新增以下代码：</p>
<pre><code class="language-js"># 404页面对应的处理函数
def page_not_found(request):
    from django.shortcuts import render_to_response
    response = render_to_response(&quot;404.html&quot;, {})
    # 设置response的状态码
    response.status_code = 404
    return response
</code></pre>
<p>接着运行项目，随意输入一个地址，发现页面并没有出来，那是因为在eduline/settings.py文件里面：<code>DEBUG = True</code>，所以我们需要修改它为<code>False</code>，还有下面的允许访问IP地址，否则404页面也是出不来的：</p>
<pre><code class="language-js">DEBUG = False

ALLOWED_HOSTS = ['*']
</code></pre>
<p>这样重新运行一下项目，发现页面有了，但是样子却没加载出来，这是为什么呢？</p>
<p>因为DEBUG为True时，系统会自动前往STATICFILES_DIRS下寻找文件。所以一般都会选择True，便于错误信息的显示。</p>
<p>但是一旦DEBUG为False时，情况就不一样了，Django就不会代管静态文件，而事实上一般静态文件都是通过第三方http服务器来代理转发。（如常见的服务器Nignx 和 Apache都会自动代理这些静态文件）</p>
<p>为了解决上述问题，可以：打开eduline/settings.py文件，新增代码如下：</p>
<pre><code class="language-js">STATIC_ROOT = os.path.join(BASE_DIR, 'static')
</code></pre>
<p>打开eduline/urls.py文件，新增代码如下：</p>
<pre><code class="language-js">from eduline.settings import  STATIC_ROOT
# 配置静态文件上传的访问处理url
    re_path('static/(?P&lt;path&gt;.*)', serve, {&quot;document_root&quot;: STATIC_ROOT}),
</code></pre>
<p>重新运行项目即可.500的页面的配置和这个一样（注意函数名为page_error）</p>
<p>隐藏的坑：按照上述步骤可以解决404/500等问题，但是进入到后台管理界面(127.0.0.1:800/xadmin)界面则会发现样式丢失！</p>
<h6 id="产生原因">产生原因：</h6>
<p>django的生产环境不同开发环境，在生产环境下（DEBUG=False）,<code>django.contrib.staticfiles </code>是不起任何作用的，也就说 <code>django.contrib.staticfiles </code>只对开发环境（DEBUG=True）开启。所以会导致xadmin样式丢失现象。</p>
<h6 id="解决方案">解决方案：</h6>
<p>① 在settings.py中添加如下配置，同时注释STATICFILES_DIRS</p>
<pre><code class="language-python"># STATICFILES_DIRS = (
#     os.path.join(BASE_DIR, &quot;static&quot;),
# )

STATIC_ROOT = os.path.join(BASE_DIR, 'static')
</code></pre>
<p>② 修改主项目中的urls.py文件</p>
<pre><code class="language-python">from.settings import STATIC_ROOT

urlpatterns = [
    //...
    url(r'^static/(?P&lt;path&gt;.*)$', serve, {&quot;document_root&quot;: STATIC_ROOT}),
]
</code></pre>
<p>③ 在控制台执行如下命令，它会在根目录下生成static文件，里边存储的是xadmin的样式文件：</p>
<pre><code class="language-python">&gt; collectstatic
</code></pre>
<p><img src="./41.jpg" alt="1565939339498"></p>
<p><img src="./42.jpg" alt="1565939297975"></p>
<h2 id="常见的web攻击">常见的Web攻击</h2>
<p>具体包括<strong>SQL注入攻击及防护</strong>，<strong>XSS攻击及防护</strong>以及<strong>CSRF攻击及防护</strong></p>
<h3 id="sql注入攻击及防护">SQL注入攻击及防护</h3>
<p>什么是SQL注入？</p>
<hr>
<p>所谓SQL注入，就是通过把SQL命令插入到Web表单提交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。具体来说，它是利用现有应用程序，将（恶意的）SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。比如先前的很多影视网站泄露VIP会员密码大多就是通过WEB表单递交查询字符暴出的，这类表单特别容易受到SQL注入式攻击。</p>
<hr>
<p>SQL注入的危害:</p>
<p>非法读取、篡改、删除数据库中的数据</p>
<p>盗取用户的各类敏感信息，获取利益</p>
<p>通过修改数据库来修改网页上的内容</p>
<p>注入木马等等</p>
<p>下面通过一段代码了解一下SQL注入的过程：</p>
<pre><code class="language-js"># users/views.py文件：
class LoginUnsafeView(View):
    def get(self, request):
        return render(request, &quot;login.html&quot;, {})
    def post(self, request):
        user_name = request.POST.get(&quot;username&quot;, &quot;&quot;)
        pass_word = request.POST.get(&quot;password&quot;, &quot;&quot;)

        import MySQLdb
        conn = MySQLdb.connect(host='127.0.0.1', user='root', passwd='root', db='mxonline', charset='utf8')
        cursor = conn.cursor()
        sql_select = &quot;select * from users_userprofile where email='{0}' and password='{1}'&quot;.format(user_name, pass_word)

        result = cursor.execute(sql_select)
        for row in cursor.fetchall():
            # 查询到用户
            pass
        print 'hello'

# eduline/urls.py文件:
from users.views import LoginUnsafeView

urlpatterns = [
    path('login/', LoginUnsafeView.as_view(), name='login'),
]
</code></pre>
<p>这里竟然把sql语句写到这里，所以可以在参数中加入sql语句，使之拼接字符串从而为真被系统识别通过，盗取用户信息。但是在Django自带了orm,可以对这个进行验证，从而保证系统的安全。因此建议采用orm这种形式，不要使用原生的sql语句。</p>
<h3 id="xss攻击及防护">XSS攻击及防护</h3>
<h3 id="csrf攻击及防护">CSRF攻击及防护</h3>
<h2 id="xadmin进阶">xadmin进阶</h2>
<h3 id="自定义icon">自定义icon</h3>
<p>以修改邮箱验证码为例，打开users/adminx.py文件，在EmailVerifyRecordAdmin函数新增一行代码：</p>
<pre><code class="language-js">model_icon = 'fa fa-user'
</code></pre>
<p>其实这个样式就是对应于<a href="http://fontawesome.io/" target="_blank" rel="noopener">font awesome</a>/http://www.fontawesome.com.cn/里面的图标，你可以下载新的源代码对目录下的css和fonts文件夹进行替换：</p>
<p><img src="./43.jpg" alt="1565963538707"></p>
<p>然后刷新一下就出现想要的样式icon了。（如果为出现，用Ctrl+F5强制刷新，还是不行的话，注销重新登录）</p>
<h3 id="默认排序字段只读字段隐藏">默认排序，字段只读，字段隐藏</h3>
<p>我们以课程为例，来介绍这3个小功能。打开couses/adminx.py文件，在CourseAdmin中加入以下代码：</p>
<pre><code class="language-js"># 默认排序：以点击数排序
ordering = ['-click_nums']

# 字段只读：点击数只允许读取
readonly_fields = ['click_nums', 'fav_nums']

# 字段隐藏：收藏数隐藏显示
exclude = ['fav_nums']

# 注意字段只读和字段隐藏是冲突的，不允许设置一个字段只读同时隐藏
</code></pre>
<h3 id="搜索框">搜索框</h3>
<p>当课程很多时，我们不能以下拉菜单的形式来查找课程，需要有搜索框。课程它有一个外键是课程机构，因此需要到课程机构里面进行搜索框的配置。打开organization/adminx.py文件，在CourseOrgAdmin函数里面添加一行代码：</p>
<pre><code class="language-js"># 搜索框，当课程数据量过大时，有课程指向它，会以ajax方式加载
    relfield_style = 'fk-ajax'
</code></pre>
<p><img src="./44.jpg" alt="1565963789074"></p>
<p><img src="./45.jpg" alt="1565963895535"></p>
<h3 id="inlines添加数据">inlines添加数据</h3>
<p>在这之前，新增课程的时候是不能同时新增课程章节信息的，需要跳到另一个页面，这是很麻烦的。所以考虑采用inlines来添加数据从而完成在一个页面直接完成章节信息的添加。</p>
<p>打开couses/adminx.py文件，在最顶部新定义一个函数：</p>
<pre><code class="language-js"># 课程直接添加章节
class LessonInline(object):
    model = Lesson
    extra = 0

# 同时在CourseAdmin中，新增一行代码
# 课程直接添加章节
class CourseAdmin(object):
    inlines = [LessonInline] # 数组，支持多个
</code></pre>
<p>刷新一下后台，发现章节信息在课程页面底部</p>
<p><img src="./46.jpg" alt="1565963922420"></p>
<p>支持多个添加，但不支持嵌套添加（只能添加一级）</p>
<pre><code class="language-python"># 再添加 一个CourseRecourseInline

class CourseRecourseInline(object):
    model = CourseRecource
    extra = 0

# 同时在CourseAdmin中，新增一行代码
# 课程直接添加章节
class CourseAdmin(object):
    inlines = [LessonInline, CourseRecourseInline] # 数组，支持多个
</code></pre>
<p>这样存储到这两个中的数据会保存到对应的表中</p>
<h3 id="一张表分两个model来进行管理">一张表分两个model来进行管理</h3>
<p>录播课程与非轮播课程可以分开管理，但是最好是在一张表里显示。打开courses/models.py文件，在course函数下面新增代码</p>
<pre><code class="language-js">class BannerCourse(Course):  # 注意是继承Course而不是object这个最高类
    class Meta:
        verbose_name = &quot;轮播课程&quot;
        verbose_name_plural = verbose_name
        proxy = True  # 很重要，否则会生成另外一张表，这样设置具有model的功能，但不会生成表
</code></pre>
<p>然后打开courses/adminx.py文件，修改之前的代码：</p>
<pre><code class="language-js">from .models import  BannerCourse

class CourseAdmin(object):
    list_display = ['image', ....','add_time']  # 一次显示你想出现的多行数据
    search_fields = ['name', ...，'click_nums']  # 查询你想要的数据
    list_filter = ['name', ..., 'click_nums','add_time']  # 过滤器
    # # 默认排序：以点击数排序
    # ordering = ['-click_nums']
    #
    # # 字段只读：点击数只允许读取
    # readonly_fields = ['click_nums', 'fav_nums']
    #
    # # 字段隐藏：收藏数隐藏显示
    # exclude = ['fav_nums']
    # # 注意字段只读和字段隐藏是冲突的，不允许设置一个字段只读同时隐藏

    # 课程直接添加章节,课程资源
    inlines = [LessonInline, CourseResourceInline]

    # 过滤列表中的数据：为了两个页面信息不重复
    def queryset(self):
        qs = super(CourseAdmin, self).queryset()
        qs = qs.filter(is_banner=False)
        return qs


class BannerCourseAdmin(object):
     list_display = ['image', ....','add_time']  # 一次显示你想出现的多行数据
    search_fields = ['name', ...，'click_nums']  # 查询你想要的数据
    list_filter = ['name', ..., 'click_nums','add_time']  # 过滤器
    # # 默认排序：以点击数排序
    # ordering = ['-click_nums']
    #
    # # 字段只读：点击数只允许读取
    # readonly_fields = ['click_nums', 'fav_nums']
    #
    # # 字段隐藏：收藏数隐藏显示
    # exclude = ['fav_nums']
    # # 注意字段只读和字段隐藏是冲突的，不允许设置一个字段只读同时隐藏

    # 课程直接添加章节,课程资源
    inlines = [LessonInline, CourseResourceInline]

    # 过滤列表中的数据
    def queryset(self):
        qs = super(BannerCourseAdmin, self).queryset()
        qs = qs.filter(is_banner=True)
        return qs

xadmin.site.register(BannerCourse, BannerCourseAdmin)
</code></pre>
<p><img src="./47.jpg" alt="1565965032042"></p>
<h3 id="直接列表页编辑">直接列表页编辑</h3>
<p>即可以直接在列表页进行更改编辑操作，在courses/adminx.py文件的CourseAdmin函数，新增一行代码：</p>
<pre><code class="language-js"> # 直接列表页编辑
    list_editable = ['degree', 'desc', ]
</code></pre>
<p><img src="./48.jpg" alt="1565965179247"></p>
<h3 id="列表页显示章节数">列表页显示章节数</h3>
<p>在courses/adminx.py文件的CourseAdmin和BannerCourseAdmin函数的list_display中，新增显示字段<code>get_zj_nums</code>，刷新后台发现是黑色的英文</p>
<p><img src="./49.jpg" alt="1565965771620"></p>
<p>需要修改，新增一行代码：</p>
<pre><code class="language-js">get_zj_nums.short_description = &quot;章节数&quot;
</code></pre>
<p><img src="./50.jpg" alt="1565965942119"></p>
<h3 id="显示自定义的html代码">显示自定义的html代码</h3>
<p>在刚才的页面下面新增以下代码：</p>
<pre><code class="language-python">def go_to(self):
	from django.utils.safestring import mark_safe
     # 如果不使用mark_safe，系统则会对其进行转义
    return mark_safe(&quot;&lt;a href='http://www.baidu.com'&gt;跳转&lt;/&gt;&quot;)

go_to.short_description = &quot;跳转&quot;
</code></pre>
<h3 id="列表页定时刷新">列表页定时刷新</h3>
<p>打开courses/adminx.py文件，在之前的CourseAdmin函数里面，新增一行代码：</p>
<pre><code> refresh_times = 3,5  # 列表页定时刷新3s或者5s
</code></pre>
<h3 id="字段联动">字段联动</h3>
<p>某一字段发生改变的时候不需要手动更改，比如添加一门课程之后，机构的课程数需要+1</p>
<pre><code class="language-js"># CourseAdmin中添加

def save_models(self):
    # 在保存课程的时候,统计课程机构的课程数
    obj = self.new_obj
    # 新增课程还没有保存，统计的课程数就会少一个
    obj.save()
    # 必须确定存在
    if obj.course_org is not None:
        # obj实际是一个course对象
        course_org = obj.course_org
        course_org.course_nums = Course.objects.filter(course_org=course_org).count()
        course_org.save()
</code></pre>
<h3 id="xadmin目录">xadmin目录</h3>
<pre><code class="language-js">- locale  对应语言包
- migrations 是数据表的记录
- plugins 每一个后台页面都是一个plugin插件
- static 静态文件夹，里面有js,css
- template 这是xadmin自己使用的html文件
- templatetags  这是tag模板
</code></pre>
<h3 id="xadmin集成富文本">xadmin集成富文本</h3>
<p>首先点击<a href="https://xadmin.readthedocs.io/en/docs-chinese/make_plugin.html" target="_blank" rel="noopener">Xadmin 插件制作</a>，学着官网的介绍，自己尝试做一个插件:富文本编辑器.</p>
<p>有坑的插件！！！先看完！！！
点击<a href="https://github.com/zhangfisher/DjangoUeditor" target="_blank" rel="noopener">DjangoUeditor</a>，获取<strong>DjangoUeditor</strong>的安装包，然后按照帮助文档或者下面的要求安装DjangoUeditor；或者<a href="https://pypi.org/" target="_blank" rel="noopener">PYPI</a>下载DjangoUeditor.</p>
<h4 id="1安装方法注意需要转到虚拟环境下面才能安装">1、安装方法(注意需要转到虚拟环境下面才能安装)</h4>
<ul>
<li>方法一：将github整个源码包下载，在命令行运行</li>
</ul>
<pre><code>python setup.py install
</code></pre>
<ul>
<li>方法二：使用pip工具在命令行运行(推荐)：</li>
</ul>
<pre><code>pip install DjangoUeditor
</code></pre>
<h4 id="2在django中安装djangoueditor">2、在Django中安装DjangoUeditor</h4>
<ul>
<li>
<p>在INSTALL_APPS里面增加</p>
<pre><code class="language-python">INSTALLED_APPS = [
    'captcha', # 验证码
    'pure_pagination', # 分页
    'DjangoUeditor',
]
</code></pre>
</li>
</ul>
<h4 id="3富文本相关path配置">3、富文本相关path配置</h4>
<p>配置url</p>
<pre><code class="language-js"># 富文本相关url
url(&quot;ueditor/&quot;, include('DjangoUeditor.urls')),
</code></pre>
<h4 id="4在models中的使用">4、在models中的使用</h4>
<pre><code class="language-js"># courses/models.py文件：

from DjangoUeditor.models import UEditorField

class Course(models.Model):

detail = UEditorField(verbose_name='课程详情', width=600, height=300, imagePath=&quot;courses/ueditor/&quot;,filePath=&quot;courses/ueditor/&quot;, default='')
</code></pre>
<h4 id="5书写代码">5、书写代码</h4>
<p>在xadmin的plugins文件夹下面，新增一个<strong>ueditor.py</strong>文件，在里面新增：</p>
<pre><code class="language-python">import xadmin

from xadmin.views import BaseAdminPlugin, CreateAdminView, ModelFormAdminView, UpdateAdminView
from DjangoUeditor.models import UEditorField
from DjangoUeditor.widgets import UEditorWidget
from django.conf import settings

class XadminUEditorWidget(UEditorWidget):
	def __init__(self,**kwargs):
        self.ueditor_options=kwargs
        self.Media.js = None
        super(XadminUEditorWidget,self).__init__(kwargs)
        
class UeditorPlugin(BaseAdminPlugin):
    def get_field_style(self, attrs, db_field, style, **kwargs):
        if style == 'ueditor':
            if isinstance(db_field, UEditorField):
                widget = db_field.formfield().widget
                param = {}
                param.update(widget.ueditor_settings)
                param.update(widget.attrs)
                return {'widget': XadminUEditorWidget(**param)}
        return attrs
    
    # 在生成的页面中放入自己的js文件
    def block_extrahead(self, context, nodes):
        js = '&lt;script type=&quot;text/javascript&quot; src=&quot;%s&quot;&gt;&lt;/script&gt;' % (settings.STATIC_URL + &quot;ueditor/ueditor.config.js&quot;)         #自己的静态目录
        js += '&lt;script type=&quot;text/javascript&quot; src=&quot;%s&quot;&gt;&lt;/script&gt;' % (settings.STATIC_URL + &quot;ueditor/ueditor.all.min.js&quot;)   #自己的静态目录
        nodes.append(js)
        
# 新增页面
xadmin.site.register_plugin(UeditorPlugin, UpdateAdminView)

# 修改页面
xadmin.site.register_plugin(UeditorPlugin, CreateAdminView)
</code></pre>
<h4 id="6字段显示样式">6、字段显示样式</h4>
<p>courses/adminx.py文件：</p>
<pre><code class="language-python">class CourseAdmin(object):
	# 字段显示样式
	style_fields = {&quot;detail&quot;: &quot;ueditor&quot;}
</code></pre>
<h4 id="7注册进入plugins">7、注册进入plugins</h4>
<p>找到plugins文件夹下的__init__.py文件，在PLUGINS中写入</p>
<pre><code class="language-python">PLUGINS= ('ueditor',)	# 与文件名一致
</code></pre>
<p>有坑！！！</p>
<p>会报错！</p>
<p><img src="./51.jpg" alt="1565968548065"></p>
<p>原因是UEditor 好像是没有Python3版本的。 直接这样安装，要自己修改里面的一些Python2的语法</p>
<p>解决方法：找到DjangoUeditor3下载命令行安装，或者解压后复制到项目下的extra_apps下</p>
<p>（可能还需要将DjangoUeditor下static中的ueditor文件夹拷贝到根目录下的static文件中）</p>
<h4 id="excel导入插件">Excel导入插件</h4>
<p><img src="./52.jpg" alt="1566010637041"></p>
<p>1、根目录下找到\extra_apps\xadmin\plugins\路径，创建excel.py文件</p>
<pre><code class="language-python"># _*_ coding:utf-8 _*_
import xadmin
from xadmin.views import BaseAdminPlugin, ListAdminView
from django.template import loader
from xadmin.plugins.utils import get_context_dict


# excel 导入
class ListImportExcelPlugin(BaseAdminPlugin):
    import_excel = False

    def init_request(self, *args, **kwargs):
        return bool(self.import_excel)

    def block_top_toolbar(self, context, nodes):
        # context = {&quot;context&quot;: context}
        nodes.append(loader.render_to_string('xadmin/excel/model_list.top_toolbar.import.html',
                                             context=get_context_dict(context)))


xadmin.site.register_plugin(ListImportExcelPlugin, ListAdminView)
</code></pre>
<p>注意：这里有个坑！按照视频或者网站上的说法写的excel.py文件会报错</p>
<p><img src="./53.jpg" alt="1566016115014"></p>
<p>原因是：<code>context_instance</code>字段在Django1.8以后产生，而在Django1.10之后就移除了，按照网上的修改方法将改成<code>context</code>，即：</p>
<pre><code class="language-python">nodes.append(loader.render_to_string('xadmin/excel/model_list.top_toolbar.import.html', context))
</code></pre>
<p>仍会报错！</p>
<p><img src="./54.jpg" alt="1566016056433"></p>
<p>再更改为</p>
<pre><code class="language-python">context = {&quot;context&quot;: context}
nodes.append(loader.render_to_string('xadmin/excel/model_list.top_toolbar.import.html', context))
</code></pre>
<p>可以完成操作，但是会报警告！</p>
<p>2、配置.html文件，即项目根目录下找到\extra_apps\xadmin\templates\xadmin，创建excel文件夹，在excel文件夹下创建model_list.top_toolbar.import.html文件，复制以下代码.</p>
<pre><code class="language-python">{% load i18n %}
&lt;div class=&quot;btn-group export&quot;&gt;
  &lt;a class=&quot;dropdown-toggle btn btn-default btn-sm&quot; data-toggle=&quot;dropdown&quot; href=&quot;#&quot;&gt;
    &lt;i class=&quot;icon-share&quot;&gt;&lt;/i&gt; 导入 &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;
  &lt;/a&gt;
  &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot; aria-labelledby=&quot;dLabel&quot;&gt;
      &lt;li&gt;&lt;a data-toggle=&quot;modal&quot; data-target=&quot;#export-modal-import-excel&quot;&gt;&lt;i class=&quot;icon-circle-arrow-down&quot;&gt;&lt;/i&gt; 导入 Excel&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
    &lt;script&gt;
        function fileChange(target){
//检测上传文件的类型
            var imgName = document.all.submit_upload.value;
            var ext,idx;
            if (imgName == ''){
                document.all.submit_upload_b.disabled=true;
                alert(&quot;请选择需要上传的 xls 文件!&quot;);
                return;
            } else {
                idx = imgName.lastIndexOf(&quot;.&quot;);
                if (idx != -1){
                    ext = imgName.substr(idx+1).toUpperCase();
                    ext = ext.toLowerCase( );
					{# alert(&quot;ext=&quot;+ext);#}
                    if (ext != 'xls' &amp;&amp; ext != 'xlsx'){
                        document.all.submit_upload_b.disabled=true;
                        alert(&quot;只能上传 .xls 类型的文件!&quot;);
 
                        return;
                    }
                } else {
                    document.all.submit_upload_b.disabled=true;
                    alert(&quot;只能上传 .xls 类型的文件!&quot;);
                    return;
                }
            }
        }
    &lt;/script&gt;
    &lt;div id=&quot;export-modal-import-excel&quot; class=&quot;modal fade&quot;&gt;
      &lt;div class=&quot;modal-dialog&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
          &lt;form method=&quot;post&quot; action=&quot;&quot; enctype=&quot;multipart/form-data&quot;&gt;
              {% csrf_token %}
          &lt;div class=&quot;modal-header&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-hidden=&quot;true&quot;&gt;×&lt;/button&gt;
            &lt;h4 class=&quot;modal-title&quot;&gt;导入 Excel&lt;/h4&gt;
          &lt;/div&gt;
          &lt;div class=&quot;modal-body&quot;&gt;
               &lt;input type=&quot;file&quot; οnchange=&quot;fileChange(this)&quot; name=&quot;excel&quot; id=&quot;submit_upload&quot;&gt;
 
          &lt;/div&gt;
          &lt;div class=&quot;modal-footer&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;{% trans &quot;Close&quot; %}&lt;/button&gt;
            &lt;button class=&quot;btn btn-success&quot; type=&quot;submit&quot; id=&quot;submit_upload_b&quot;&gt;&lt;i class=&quot;icon-share&quot;&gt;&lt;/i&gt; 导入&lt;/button&gt;
          &lt;/div&gt;
          &lt;/form&gt;
        &lt;/div&gt;&lt;!-- /.modal-content --&gt;
      &lt;/div&gt;&lt;!-- /.modal-dalog --&gt;
    &lt;/div&gt;&lt;!-- /.modal --&gt;
 
&lt;/div&gt;
</code></pre>
<p>3、在想导入的XxxAdmin下添加<code>impotr_excel = True</code>，并且重写post方法</p>
<pre><code class="language-python"> def post(self, request, *args, **kwargs):
    #  导入逻辑
    if 'excel' in request.FILES:
        pass
    return super(CourseAdmin, self).post(request, args, kwargs)
</code></pre>
<p>4、最后在xadmin/plugins文件夹下找到<code>__init__.py</code>文件夹，添加</p>
<pre><code>PLUGINS = (
    'excel',
)
</code></pre>
<p><img src="./55.jpg" alt="1566021359412"></p>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>
  
  <a class="badge badge-light" href="/tag/django/">Django</a>
  
  <a class="badge badge-light" href="/tag/python/">Python</a>
  
</div>













  
  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://CoMath21.github.io/"><img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu229ab2ae4b832f0d41c08e3dce763b22_681268_270x270_fill_q75_lanczos_center.jpg" alt="Xin态好先生"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://CoMath21.github.io/">Xin态好先生</a></h5>
      
      <p class="card-text">机会是给有准备的人的.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:comath@qq.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=1375264022&amp;site=qq&amp;menu=yes" target="_blank" rel="noopener">
        <i class="fab fa-qq"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/CoMath21" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/" >
        <i class="fas fa-graduation-cap"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://CoMath21.github.io/"><img class="avatar mr-3 avatar-circle" src="/authors/comath/avatar_hu5dbed3c1e225bfb246e59dc7d66e77de_260503_270x270_fill_lanczos_center_2.png" alt="CoMath"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://CoMath21.github.io/">CoMath</a></h5>
      <h6 class="card-subtitle">微信公众号</h6>
      
      <ul class="network-icon" aria-hidden="true">
  
</ul>

    </div>
  </div>


  














  
  
  <div class="article-widget content-widget-hr">
    <h3>相关</h3>
    <ul>
      
      <li><a href="/post/0-python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%904/">Python数据分析（四）</a></li>
      
      <li><a href="/post/0-python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%903/">Python数据分析（三）</a></li>
      
      <li><a href="/post/0-python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%902/">Python数据分析（二）</a></li>
      
      <li><a href="/post/0-python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%901/">Python数据分析（一）</a></li>
      
      <li><a href="/post/1-ssh%E6%A1%86%E6%9E%B6%E6%95%B4%E5%90%88/">SSH框架整合基本步骤</a></li>
      
    </ul>
  </div>
  





  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">
  

  <p class="powered-by">
    © 2021 CoMath Powered by Hugo Theme Academic
  </p>

  
  






  <p class="powered-by">
    
    
    
    Published with
    <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a>  —
    the free, <a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">
    open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 复制
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下载
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"没有找到结果","placeholder":"搜索...","results":"搜索结果"};
      const content_type = {
        'post': "文章",
        'project': "项目",
        'publication' : "出版物",
        'event' : "演讲",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/js/wowchemy.min.aeecf26c1eff6b9588dbafc1a9f3953c.js"></script>

    






</body>
</html>
